<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-x32.ico"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-x16.ico"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="google-site-verification" content="veaTBtqt4ArdFO7yL4lECMYJsOeSwdptb1k8vJJBzMA"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css"><script src="/lib/pace/pace.min.js"></script><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://lyreal666.com").hostname,root:"/",scheme:"Pisces",version:"7.7.1",exturl:!0,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!0,style:"default"},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!0,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="本篇为 从零开始配置 react + typescript 系列第三篇，将带大家完成模板项目的 webpack 配置。整个项目的配置我力求达到以下目标：灵活： 我在配置 eslint 是选择使用 js 格式而不是 json，就是为了灵活性，使用 js 文件可以让你使用导入其它模块，根据开发环境动态配置，充分发挥 js 语言的能力。新潮： 我觉得时刻保持对新事物的关注和尝试去使用它是一个优秀的素质。"><meta property="og:type" content="article"><meta property="og:title" content="从零开始配置 react + typescript（三）：webpack"><meta property="og:url" content="https://lyreal666.com/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E9%85%8D%E7%BD%AE-react-typescript%EF%BC%88%E4%B8%89%EF%BC%89%EF%BC%9Awebpack/index.html"><meta property="og:site_name" content="余腾靖的博客"><meta property="og:description" content="本篇为 从零开始配置 react + typescript 系列第三篇，将带大家完成模板项目的 webpack 配置。整个项目的配置我力求达到以下目标：灵活： 我在配置 eslint 是选择使用 js 格式而不是 json，就是为了灵活性，使用 js 文件可以让你使用导入其它模块，根据开发环境动态配置，充分发挥 js 语言的能力。新潮： 我觉得时刻保持对新事物的关注和尝试去使用它是一个优秀的素质。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://i.loli.net/2020/02/16/QS1lFJt7fbIYEcG.png"><meta property="og:image" content="https://i.loli.net/2020/02/16/PVpnHNC9G7rEtQT.png"><meta property="og:image" content="https://i.loli.net/2020/02/20/lLQEXfwgY5khOeM.png"><meta property="og:image" content="https://github.com/sindresorhus/log-symbols/raw/master/screenshot.png"><meta property="og:image" content="https://i.loli.net/2020/02/16/DevliamMEKy1hTt.gif"><meta property="og:image" content="https://i.loli.net/2020/02/17/kqngMuoNQWj2CyG.png"><meta property="og:image" content="https://camo.githubusercontent.com/cb9c82719765ad966a2771f084175c9ec935124e/687474703a2f2f692e696d6775722e636f6d2f4f495031676e6a2e676966"><meta property="og:image" content="https://i.loli.net/2020/02/16/MvEgi4sw7WkjbnT.png"><meta property="og:image" content="https://i.loli.net/2020/02/19/MGDZLJBcK2yToN6.png"><meta property="og:image" content="https://i.loli.net/2020/02/19/bj9hRKeUBMG1Hmv.png"><meta property="og:image" content="https://i.loli.net/2020/02/19/wsWuPkh3x9GlL4a.png"><meta property="og:image" content="https://i.loli.net/2020/02/16/czN2UDhGiXb3TJ5.png"><meta property="og:image" content="https://i.loli.net/2020/02/16/FWdazBElvG8Mq4U.png"><meta property="og:image" content="https://i.loli.net/2020/04/03/3fLepM1GSBAPjh4.png"><meta property="og:image" content="https://i.loli.net/2020/02/16/bHQEPLK1WiCXlBA.png"><meta property="og:image" content="https://i.loli.net/2020/02/16/VOxjym6zZFftkhr.png"><meta property="og:image" content="https://i.loli.net/2020/02/19/4wW75dVszApkQGe.png"><meta property="og:image" content="https://i.loli.net/2020/02/19/8OnBuWedj5z2CFP.png"><meta property="og:image" content="https://i.loli.net/2020/02/17/ZucCU1dEev372bS.png"><meta property="og:image" content="https://i.loli.net/2020/02/17/q5B6kUFSm3TyiLl.png"><meta property="og:image" content="https://i.loli.net/2020/02/20/Mxsl8rQdU1tNiYm.png"><meta property="og:image" content="https://i.loli.net/2020/02/20/IouO1Kvt5wFAWVl.png"><meta property="og:image" content="https://raw.githubusercontent.com/smooth-code/error-overlay-webpack-plugin/master/docs/example.png"><meta property="og:image" content="https://i.loli.net/2020/02/18/h1njS2olHADUV8R.png"><meta property="og:image" content="https://i.loli.net/2020/02/20/DusmAYnTV2JL4Xv.png"><meta property="og:image" content="https://i.loli.net/2020/02/19/c1vdoqsT34WCSHX.png"><meta property="og:image" content="https://i.loli.net/2020/02/19/Plifd7e9b2WOxsF.png"><meta property="og:image" content="https://i.loli.net/2020/02/19/Oteqp9js3DPFrCS.png"><meta property="og:image" content="https://i.loli.net/2020/02/19/ecaJjBtpHIEQoxC.gif"><meta property="article:published_time" content="2020-02-14T12:15:56.000Z"><meta property="article:modified_time" content="2020-04-03T15:18:02.569Z"><meta property="article:author" content="余腾靖"><meta property="article:tag" content="react"><meta property="article:tag" content="typescript"><meta property="article:tag" content="webpack"><meta property="article:tag" content="express"><meta property="article:tag" content="babel"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://i.loli.net/2020/02/16/QS1lFJt7fbIYEcG.png"><link rel="canonical" href="https://lyreal666.com/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E9%85%8D%E7%BD%AE-react-typescript%EF%BC%88%E4%B8%89%EF%BC%89%EF%BC%9Awebpack/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>从零开始配置 react + typescript（三）：webpack | 余腾靖的博客</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="余腾靖的博客" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">余腾靖的博客</span> <span class="logo-line-after"><i></i></span></a></div></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="fa fa-fw fa-link"></i>友链</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://lyreal666.com/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E9%85%8D%E7%BD%AE-react-typescript%EF%BC%88%E4%B8%89%EF%BC%89%EF%BC%9Awebpack/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="余腾靖"><meta itemprop="description" content="总结和分享我的所学所思"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="余腾靖的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">从零开始配置 react + typescript（三）：webpack</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-02-14 20:15:56" itemprop="dateCreated datePublished" datetime="2020-02-14T20:15:56+08:00">2020-02-14</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2020-04-03 23:18:02" itemprop="dateModified" datetime="2020-04-03T23:18:02+08:00">2020-04-03</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span> </a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><p>本篇为 <code>从零开始配置 react + typescript</code> 系列第三篇，将带大家完成模板项目的 webpack 配置。整个项目的配置我力求达到以下目标：</p><p><strong>灵活：</strong> 我在配置 eslint 是选择使用 js 格式而不是 json，就是为了灵活性，使用 js 文件可以让你使用导入其它模块，根据开发环境动态配置，充分发挥 js 语言的能力。</p><p><strong>新潮：</strong> 我觉得时刻保持对新事物的关注和尝试去使用它是一个优秀的素质。当然，追新很容易碰到坑，但是，没关系，我已经帮你们踩过了，踩不过去我也不会写出来 😂。从我 eslint <code>parserOptions.ecmaVersion</code> 设置为 2020， 还有经常来一发 <code>yarn upgrade --latest</code> 都可以体现出来。</p><p><strong>严格：</strong> 就像我平时判断相等性我大多数情况都是使用严格等 <code>===</code>，而不是非严格等 <code>==</code>，我觉得越严格，分析起来就越清晰，越早能发现问题。例如我么后面会使用一些 webpack 插件来严格检查模块大小写，检查是否有循环依赖。</p><p><strong>安逸：</strong> 项目中会尽量集成当前前端生态界实用的和能提高开发愉悦性的（换个词就是花里胡哨）工具。</p><p><strong>生产 ready</strong>：配置的时候针对不同的打包环境针对性优化，并确保能够投入生产环境使用。</p><p>本篇将分三大部分介绍：</p><ol><li>dev server</li><li>开发环境优化</li><li>生产环境优化</li></ol><p>如果读者是初次看到这篇文章，建议先看下前两篇：</p><ol><li><a href="https://lyreal666.com/从零开始配置-react-typescript（一）：dotfiles/">从零开始配置 react + typescript（一）：dotfiles</a></li><li><a href="https://lyreal666.com/从零开始配置-react-typescript（二）：linters-和-formatter/">从零开始配置 react + typescript（二）：linters 和 formatter</a></li></ol><p>项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RqeDY2Ni9yZWFjdC10eXBlc2NyaXB0LWJvaWxlcnBsYXRl" title="https://github.com/tjx666/react-typescript-boilerplate">react-typescript-boilerplate<i class="fa fa-external-link"></i></span></p><a id="more"></a><h2 id="dev-server"><a href="#dev-server" class="headerlink" title="dev server"></a>dev server</h2><p>想当初我刚开始学前端框架的那时候，也是被 webpack 折磨的欲仙欲死，我是先自学的 node 才开始写前端，写 nodejs 很方便，自带的模块化方案 <code>commonjs</code>，写前端项目就要配置打包工具。当时最火的打包工具已经是 webpack 了，其次就是 <code>gulp</code>。配置 webpack 总是记不住 webpack 配置有哪些字段，还要扯到一堆相关的工具像 ES6 编译器 <code>babel</code>，CSS 预处理器 <code>sass</code>/<code>less</code>，CSS 后处理器 <code>postcss</code>，以及各种 webpack 的 loader 和 plugin。然后嫌麻烦就有一段时间都是用官方的脚手架，react 就用 <code>cra</code>，也就是 <code>create-react-app</code>，vue 就用 <code>vue-cli</code>。其实也挺好用的，不过说实话，我个人觉得，<code>cra</code> 没 <code>vue-cli</code> 设计的好，无论是易用性和扩展性都完败，cra 不方便用户修改 webpack 配置，vue-cli 不但易于用户修改 webpack 配置，还能让用户保存模板以及自带插件系统。我感觉 react 官方也意识到了这点，所以官方声称近期将会重点优化相关工具链。现在的话，如果我新建一个前端项目，我会选择自己配，不会去采用官方的 cli，因为我觉得我自己已经相当熟悉前端各种构建工具了，等我上半年忙完毕业和找工作的事情我应该会将一些常用的配置抽成一个 npm 包，现在每次写一个项目都 copy 改太累了，一个项目的构建配置有优化点，其它项目都要手动同步一下，效率太低。</p><h3 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a>技术选型</h3><p>TypeScript 作为静态类型语言，相对于 js 而言，在类型提示上带来的提升无疑是巨大的。借助 IDE 的类型提示和代码补全，我们需要知道 webpack 配置对象有哪些字段就不用去查官方文档了，而且还不会敲错，很安逸，所以开发语言就选择 <strong>TypeScript</strong>。</p><p>官方文档上有专门一节 <span class="exturl" data-url="aHR0cHM6Ly93ZWJwYWNrLmpzLm9yZy9jb25maWd1cmF0aW9uL2NvbmZpZ3VyYXRpb24tbGFuZ3VhZ2VzLw==" title="https://webpack.js.org/configuration/configuration-languages/">Configuration Languages<i class="fa fa-external-link"></i></span> 介绍 webpack 命令行工具怎么使用 ts 格式的配置文件 ，我觉得 <code>webpack-dev-server</code> 命令行工具应该是一样的。</p><p>但是我不打算使用官方文档介绍的方式，我压根不打算使用命令行工具，用 node API 才是<strong>最灵活</strong>的配置方式。配置 <code>webpack devServer</code> 总结一下有以下方式：</p><ol><li><code>webpack-dev-server</code>，这是最不灵活的方式，当然使用场景简单的情况下还是很方便的</li><li><code>webpack-dev-server</code> node API，在 node 脚本里面调用 <code>web-dev-server</code> 包提供的 node API 来启动 devServer</li><li><code>express</code> + <code>webpack devServer 相关中间件</code>，实际上 <code>webpack-dev-server</code> 就是使用 <code>express</code> 以及一些 devServer 相关的中间件开发的。在这种方式下， 各种中间件直接暴露出来了，我们可以灵活配置各个中间件的选项。</li><li><code>koa</code> + <code>webpack devServer 相关中间件</code>，我在 github 上还真的搜到了和 webpack devServer 相关的 webpack 中间件。其实 webpack devServer 就是一个 node server 嘛，用什么框架技术实现不重要，能实现我们需要的功能就行。</li></ol><p>我最终采用 <code>express</code> + <code>webpack devServer 相关中间件</code>的方式，为什么不选择用 <code>koa</code> ？因为我觉得官方用的就是 <code>express</code>，用 <code>express</code> 肯定要比 <code>koa</code> 更成熟稳定，坑要少一些。</p><h3 id="实现最基本的打包功能"><a href="#实现最基本的打包功能" class="headerlink" title="实现最基本的打包功能"></a>实现最基本的打包功能</h3><p>从简到繁，我们先来实现最基本的打包功能使其能够打包 <code>tsx</code> 文件，在此基础上一步一步丰富，优化我们的配置。</p><h4 id="配置入口文件"><a href="#配置入口文件" class="headerlink" title="配置入口文件"></a>配置入口文件</h4><p>先安装 TypeScript：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 本地安装开发依赖 typescript</span></span><br><span class="line">yarn add typescript -D</span><br></pre></td></tr></table></figure><p>每个 TypeScript 项目都需要有一个 <code>tsconfig.json</code> 配置文件，使用下面的命令在 <code>src</code> 目录下新建 <code>tsconfig.json</code> 文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> src &amp;&amp; npx tsc --init &amp;&amp; <span class="built_in">cd</span> ..</span><br></pre></td></tr></table></figure><p>我们暂时调整成这样：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"compilerOptions"</span>: &#123;</span><br><span class="line">        <span class="comment">/* Basic Options */</span></span><br><span class="line">        <span class="string">"jsx"</span>: <span class="string">"react"</span>,</span><br><span class="line">        <span class="string">"isolatedModules"</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Strict Type-Checking Options */</span></span><br><span class="line">        <span class="string">"strict"</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Additional Checks */</span></span><br><span class="line">        <span class="string">"noUnusedLocals"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"noUnusedParameters"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"noImplicitReturns"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"noFallthroughCasesInSwitch"</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Module Resolution Options */</span></span><br><span class="line">        <span class="string">"moduleResolution"</span>: <span class="string">"node"</span>,</span><br><span class="line">        <span class="string">"esModuleInterop"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"resolveJsonModule"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"baseUrl"</span>: <span class="string">"./"</span>,</span><br><span class="line">        <span class="string">"paths"</span>: &#123;</span><br><span class="line">            <span class="comment">// 配置模块路径映射</span></span><br><span class="line">            <span class="string">"@/*"</span>: [<span class="string">"./*"</span>],</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Experimental Options */</span></span><br><span class="line">        <span class="string">"experimentalDecorators"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"emitDecoratorMetadata"</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Advanced Options */</span></span><br><span class="line">        <span class="string">"forceConsistentCasingInFileNames"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"skipLibCheck"</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 下面这些选项对 babel 编译 TypeScript 没有作用但是可以让 VSCode 等编辑器正确提示错误</span></span><br><span class="line">        <span class="string">"target"</span>: <span class="string">"ES2019"</span>,</span><br><span class="line">        <span class="string">"module"</span>: <span class="string">"ESNext"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们将使用 babel 去编译 TypeScript，babel 在编译 TypeScript 代码是直接去掉 TypeScript 的类型，然后当成普通的 javascript 代码使用各种插件进行编译，tsc 并没有介入编译过程，因此 <code>tsconfig.json</code> 中很多选项例如 <code>target</code> 和 <code>module</code> 是没有用的。</p><p>启用 <code>isolatedModules</code> 选项会在 babel 编译代码时提供一些额外的检查，<code>esModuleInterop</code> 这个选项是用来为了让没有 default 属性的模块也可以使用默认导入，举个简单的例子，如果这个选项没开启，那你导入 fs 模块只能像下面这样导入：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> fs <span class="keyword">from</span> <span class="string">'fs'</span>;</span><br></pre></td></tr></table></figure><p>开启了以后，可以直接使用默认导入：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">'fs'</span>;</span><br></pre></td></tr></table></figure><p>本质上 ESM 默认导入是导入模块的 default 属性：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">'fs'</span>;</span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> __module__ <span class="keyword">from</span> <span class="string">'fs'</span>;</span><br><span class="line"><span class="keyword">let</span> fs = __module__.default;</span><br></pre></td></tr></table></figure><p>但是 node 内建模块 fs 是没有 default 属性的，开启 <code>isolatedModules</code> 选项就会在没有 default 属性的情况下自动转换：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> fs, &#123; resolve &#125; <span class="keyword">from</span> <span class="string">'fs'</span>;</span><br><span class="line"><span class="comment">// 转换成</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> fs <span class="keyword">from</span> <span class="string">'fs'</span>;</span><br><span class="line"><span class="keyword">let</span> &#123; resolve &#125; = fs;</span><br></pre></td></tr></table></figure><p>我们添加一个入口文件 <code>src/index.tsx</code>，内容很简单：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> plus <span class="keyword">from</span> <span class="string">'./plus'</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(plus(<span class="number">404</span>, <span class="number">404</span>, <span class="number">404</span>, <span class="number">404</span>, <span class="number">404</span>)); <span class="comment">// =&gt; 2020</span></span><br></pre></td></tr></table></figure><p><code>src/plus.ts</code> 内容为：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">plus</span>(<span class="params">...nums: number[]</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> nums.reduce(<span class="function">(<span class="params">pre, current</span>) =&gt;</span> pre + current, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="编译-TypeScript"><a href="#编译-TypeScript" class="headerlink" title="编译 TypeScript"></a>编译 TypeScript</h4><p>我们知道 webpack 默认的模块化系统只支持 js 文件，对于其它类型的文件如 jsx, ts, tsx, vue 以及图片字体等文件类型，我们需要安装对应的 loader。对于 ts 文件，目前存在比较流行的方案有三种:</p><ol><li><p>babel + <span class="exturl" data-url="aHR0cHM6Ly9iYWJlbGpzLmlvL2RvY3MvZW4vYmFiZWwtcHJlc2V0LXR5cGVzY3JpcHQ=" title="https://babeljs.io/docs/en/babel-preset-typescript">@babel/preset-typescript<i class="fa fa-external-link"></i></span></p></li><li><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1R5cGVTdHJvbmcvdHMtbG9hZGVy" title="https://github.com/TypeStrong/ts-loader">ts-loader<i class="fa fa-external-link"></i></span></p></li><li><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3MtcGFuZmVyb3YvYXdlc29tZS10eXBlc2NyaXB0LWxvYWRlcg==" title="https://github.com/s-panferov/awesome-typescript-loader">awesome-typescript-loader<i class="fa fa-external-link"></i></span></p></li></ol><p>awesome-typescript-loader 就算了，作者已经放弃维护了。首先 babel 我们一定要用的，因为 babel 生态有很多实用的插件。虽然 babel 是可以和 ts-loader 一起用，ts-loader 官方给了一个例子 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1R5cGVTdHJvbmcvdHMtbG9hZGVyL3RyZWUvbWFzdGVyL2V4YW1wbGVzL3JlYWN0LWJhYmVsLWthcm1hLWd1bHA=" title="https://github.com/TypeStrong/ts-loader/tree/master/examples/react-babel-karma-gulp">react-babel-karma-gulp<i class="fa fa-external-link"></i></span>，但是我觉得既然 babel 已经能够编译 TypeScript 我们就没必要再加一个 ts-loader，所以我选择方案一。需要指出的一点就是就是 babel 默认不会检查 TypeScript 的类型，后面 webpack 插件部分我们会通过配置 <code>fork-ts-checker-webpack-plugin</code> 来解决这个问题。</p><h4 id="添加-webpack-配置"><a href="#添加-webpack-配置" class="headerlink" title="添加 webpack 配置"></a>添加 webpack 配置</h4><p>我们将把所有 node 脚本放到项目根目的 <code>scripts</code> 文件夹，因为 <code>src</code> 文件夹是前端项目，而 <code>scripts</code> 文件夹是 node 项目，我们应该分别配置 <code>tsconfig.json</code>，通过下面的命令在其中生成初始的 <code>tsconfig.json</code> 文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ./scripts &amp;&amp; npx tsc --init &amp;&amp; <span class="built_in">cd</span> ..</span><br></pre></td></tr></table></figure><p>我们调整成酱：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// scripts/tsconfig.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"compilerOptions"</span>: &#123;</span><br><span class="line">        <span class="comment">/* Basic Options */</span></span><br><span class="line">        <span class="string">"target"</span>: <span class="string">"ES2019"</span>,</span><br><span class="line">        <span class="string">"module"</span>: <span class="string">"commonjs"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Strict Type-Checking Options */</span></span><br><span class="line">        <span class="string">"strict"</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Additional Checks */</span></span><br><span class="line">        <span class="string">"noUnusedLocals"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"noUnusedParameters"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"noImplicitReturns"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"noFallthroughCasesInSwitch"</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Module Resolution Options */</span></span><br><span class="line">        <span class="string">"moduleResolution"</span>: <span class="string">"node"</span>,</span><br><span class="line">        <span class="string">"esModuleInterop"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"resolveJsonModule"</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Experimental Options */</span></span><br><span class="line">        <span class="string">"experimentalDecorators"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"emitDecoratorMetadata"</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Advanced Options */</span></span><br><span class="line">        <span class="string">"forceConsistentCasingInFileNames"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"skipLibCheck"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>提几个需要注意的地方：</p><ul><li><p><code>&quot;target&quot;: &quot;ES2019&quot;</code>，其实编译级别你调的很低是没问题的，你用高级语法 tsc 就转码呗，缺点就是转码后代码体积一般会变大，执行效率也会降低，原生语法一般都是被优化过的。我喜欢调高一点，一般来说只要不用那些在代码运行平台还不支持的语法就没问题。自从 TypeScript3.7 支持了可选链，我就开始尝试在 TypeScript 使用它，但是问题来了，我之前编译级别一直都是调成最高，也就是 <code>ESNext</code>，因为可选链在 <code>ES2020</code> 已经是标准了，所以 tsc 对于可选链不会转码的。然后 node 12 还不支持可选链，就会报语法错误，于是我就降到 <code>ES2019</code> 了。</p></li><li><p><code>Strict Type-Checking Options</code>，这部分全开，既然上了 TypeScript 的船，就用最严格的类型检查，拒绝 AnyScript</p></li></ul><p>接着我们新建 <code>scripts/configs</code>文件夹，里面用来存放包括 webpack 的配置文件。在其中新建三个 webpack 的配置文件 <code>webpack.common.ts</code>， <code>webpack.dev.ts</code>和 <code>webapck.prod.ts</code>。<code>webpack.common.ts</code> 保存一些公共的配置文件，<code>webpack.dev.ts</code> 是开发环境用的，会被 devServer 读取，<code>webapck.prod.ts</code> 是我们在构建生产环境的 bundle 时用的。</p><p>我们接着安装 webpack 和 webpack-merge 以及它们的类型声明文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add webpack webpack-merge @types/webpack @types/webpack-merge -D</span><br></pre></td></tr></table></figure><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3N1cnZpdmVqcy93ZWJwYWNrLW1lcmdl" title="https://github.com/survivejs/webpack-merge">webpack-merge<i class="fa fa-external-link"></i></span> 是一个为 merge webpack 配置设计的 merge 工具，提供了一些高级的 merge 方式。不过我目前并没有用到那些高级的 merge 方式，就是当成普通的 merge 工具使用，后续可以探索一下这方面的优化。</p><p>为了编译 tsx，我们需要安装 <code>babel-loader</code> 和相关插件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add babel-loader @babel/core @babel/preset-typescript -D</span><br></pre></td></tr></table></figure><p>新建 babel 配置文件 <code>babel.config.js</code>，现在我们只添加一个 TypeScript preset：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// babel.config.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">api</span>) </span>&#123;</span><br><span class="line">  api.cache(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> presets = [<span class="string">'@babel/preset-typescript'</span>];</span><br><span class="line">  <span class="keyword">const</span> plugins = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    presets,</span><br><span class="line">    plugins,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>添加 babel-loader 到 <code>webpack.common.ts</code>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.common.ts`</span></span><br><span class="line"><span class="keyword">import</span> &#123; Configuration &#125; <span class="keyword">from</span> <span class="string">'webpack'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; projectName, projectRoot, resolvePath &#125; <span class="keyword">from</span> <span class="string">'../env'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> commonConfig: Configuration = &#123;</span><br><span class="line">  context: projectRoot,</span><br><span class="line">  entry: resolvePath(projectRoot, <span class="string">'./src/index.tsx'</span>),</span><br><span class="line">  output: &#123;</span><br><span class="line">    publicPath: <span class="string">'/'</span>,</span><br><span class="line">    path: resolvePath(projectRoot, <span class="string">'./dist'</span>),</span><br><span class="line">    filename: <span class="string">'js/[name]-[hash].bundle.js'</span>,</span><br><span class="line">    <span class="comment">// 加盐 hash</span></span><br><span class="line">    hashSalt: projectName || <span class="string">'react typescript boilerplate'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  resolve: &#123;</span><br><span class="line">    <span class="comment">// 我们导入ts 等模块一般不写后缀名，webpack 会尝试使用这个数组提供的后缀名去导入</span></span><br><span class="line">    extensions: [<span class="string">'.ts'</span>, <span class="string">'.tsx'</span>, <span class="string">'.js'</span>, <span class="string">'.json'</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// 导入 jsx 的人少喝点</span></span><br><span class="line">        test: <span class="regexp">/\.(tsx?|js)$/</span>,</span><br><span class="line">        loader: <span class="string">'babel-loader'</span>,</span><br><span class="line">        <span class="comment">// 开启缓存</span></span><br><span class="line">        options: &#123; <span class="attr">cacheDirectory</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">        exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>我觉得这个 react + ts 项目不应该会出现 jsx 文件，如果导入了 jsx 文件 webpack 就会报错找不到对应的 loader，可以让我们及时处理掉这个有问题的文件。</p><h4 id="使用-express-开发-devServer"><a href="#使用-express-开发-devServer" class="headerlink" title="使用 express 开发 devServer"></a>使用 express 开发 devServer</h4><p>我们先安装 <code>express</code> 以及和 webpack devServer 相关的一些中间件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yarn add express webpack-dev-middleware webpack-hot-middleware @types/express @t</span><br><span class="line">ypes/webpack-dev-middleware @types/webpack-hot-middleware -D</span><br></pre></td></tr></table></figure><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dlYnBhY2svd2VicGFjay1kZXYtbWlkZGxld2FyZQ==" title="https://github.com/webpack/webpack-dev-middleware">webpack-dev-middleware<i class="fa fa-external-link"></i></span> 这个 <code>express</code> 中间件的主要作用：</p><ol><li>作为一个静态文件服务器，使用内存文件系统托管 webpack 编译出的 bundle</li><li>如果文件被修改了，会延迟服务器的请求直到编译完成</li><li>配合 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dlYnBhY2stY29udHJpYi93ZWJwYWNrLWhvdC1taWRkbGV3YXJl" title="https://github.com/webpack-contrib/webpack-hot-middleware">webpack-hot-middleware<i class="fa fa-external-link"></i></span> 实现热更新功能</li></ol><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dlYnBhY2stY29udHJpYi93ZWJwYWNrLWhvdC1taWRkbGV3YXJl" title="https://github.com/webpack-contrib/webpack-hot-middleware">webpack-hot-middleware<i class="fa fa-external-link"></i></span> 这个 express 中间件会将自己注册为一个 webpack 插件，监听 webpack 的编译事件。 你哪个 entry 需要实现热更新，就要在那个 entry 中导入这个插件提供的 <code>webpack-hot-middleware/client.js</code> 客户端补丁。这个前端代码会获取 devServer 的 <span class="exturl" data-url="aHR0cDovL3d3dy5odG1sNXJvY2tzLmNvbS9lbi90dXRvcmlhbHMvZXZlbnRzb3VyY2UvYmFzaWNzLw==" title="http://www.html5rocks.com/en/tutorials/eventsource/basics/">Server Sent Events<i class="fa fa-external-link"></i></span> 连接，当有编译事件发生，devServer 会发布通知给这个客户端。客户端接受到通知后，会通过比对 hash 值判断本地代码是不是最新的，如果不是就会向 devServer 拉取更新补丁借助一些其它的工具例如 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dhZWFyb24vcmVhY3QtaG90LWxvYWRlcg==" title="https://github.com/gaearon/react-hot-loader">react-hot-loader<i class="fa fa-external-link"></i></span> 实现热更新。</p><p>下面是我另外一个还在开发的 electron 项目修改了一行代码后， client 补丁发送的两次请求：</p><p><img data-src="https://i.loli.net/2020/02/16/QS1lFJt7fbIYEcG.png" alt="hash"></p><p><img data-src="https://i.loli.net/2020/02/16/PVpnHNC9G7rEtQT.png" alt="update"></p><p>第一次请求返回的那个 h 值动动脚趾头就能猜出来就是 hash 值，发现和本地的 hash 值比对不上后，再次请求更新补丁。</p><p>我们新建文件 <code>scripts/start.ts</code> 用来启动我们的 devServer：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> chalk <span class="keyword">from</span> <span class="string">'chalk'</span>;</span><br><span class="line"><span class="keyword">import</span> getPort <span class="keyword">from</span> <span class="string">'get-port'</span>;</span><br><span class="line"><span class="keyword">import</span> logSymbols <span class="keyword">from</span> <span class="string">'log-symbols'</span>;</span><br><span class="line"><span class="keyword">import</span> open <span class="keyword">from</span> <span class="string">'open'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; argv &#125; <span class="keyword">from</span> <span class="string">'yargs'</span>;</span><br><span class="line"><span class="keyword">import</span> express, &#123; Express &#125; <span class="keyword">from</span> <span class="string">'express'</span>;</span><br><span class="line"><span class="keyword">import</span> webpack, &#123; Compiler, Stats &#125; <span class="keyword">from</span> <span class="string">'webpack'</span>;</span><br><span class="line"><span class="keyword">import</span> historyFallback <span class="keyword">from</span> <span class="string">'connect-history-api-fallback'</span>;</span><br><span class="line"><span class="keyword">import</span> cors <span class="keyword">from</span> <span class="string">'cors'</span>;</span><br><span class="line"><span class="keyword">import</span> webpackDevMiddleware <span class="keyword">from</span> <span class="string">'webpack-dev-middleware'</span>;</span><br><span class="line"><span class="keyword">import</span> webpackHotMiddleware <span class="keyword">from</span> <span class="string">'webpack-hot-middleware'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> proxy <span class="keyword">from</span> <span class="string">'./proxy'</span>;</span><br><span class="line"><span class="keyword">import</span> devConfig <span class="keyword">from</span> <span class="string">'./configs/webpack.dev'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; hmrPath &#125; <span class="keyword">from</span> <span class="string">'./env'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">openBrowser</span>(<span class="params">compiler: Compiler, address: string</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argv.open) &#123;</span><br><span class="line">        <span class="keyword">let</span> hadOpened = <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// 编译完成时执行</span></span><br><span class="line">        compiler.hooks.done.tap(<span class="string">'open-browser-plugin'</span>, <span class="keyword">async</span> (stats: Stats) =&gt; &#123;</span><br><span class="line">            <span class="comment">// 没有打开过浏览器并且没有编译错误就打开浏览器</span></span><br><span class="line">            <span class="keyword">if</span> (!hadOpened &amp;&amp; !stats.hasErrors()) &#123;</span><br><span class="line">                <span class="keyword">await</span> open(address);</span><br><span class="line">                hadOpened = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setupMiddlewares</span>(<span class="params">compiler: Compiler, server: Express</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> publicPath = devConfig.output!.publicPath!;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置代理</span></span><br><span class="line">    proxy(server);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 browserRouter 需要重定向所有 html 页面到首页</span></span><br><span class="line">    server.use(historyFallback());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开发 chrome 扩展的时候可能需要开启跨域，参考：https://juejin.im/post/5e2027096fb9a02fe971f6b8</span></span><br><span class="line">    server.use(cors());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> devMiddlewareOptions: webpackDevMiddleware.Options = &#123;</span><br><span class="line">        <span class="comment">// 保持和 webpack 中配置一致</span></span><br><span class="line">        publicPath,</span><br><span class="line">        <span class="comment">// 只在发生错误或有新的编译时输出</span></span><br><span class="line">        stats: <span class="string">'minimal'</span>,</span><br><span class="line">        <span class="comment">// 需要输出文件到磁盘可以开启</span></span><br><span class="line">        <span class="comment">// writeToDisk: true</span></span><br><span class="line">    &#125;;</span><br><span class="line">    server.use(webpackDevMiddleware(compiler, devMiddlewareOptions));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> hotMiddlewareOptions: webpackHotMiddleware.Options = &#123;</span><br><span class="line">        <span class="comment">// sse 路由</span></span><br><span class="line">        path: hmrPath,</span><br><span class="line">        <span class="comment">// 编译出错会在网页中显示出错信息遮罩</span></span><br><span class="line">        overlay: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// webpack 卡住自动刷新页面</span></span><br><span class="line">        reload: <span class="literal">true</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    server.use(webpackHotMiddleware(compiler, hotMiddlewareOptions));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> HOST = <span class="string">'127.0.0.1'</span>;</span><br><span class="line">    <span class="comment">// 4个备选端口，都被占用会使用随机端口</span></span><br><span class="line">    <span class="keyword">const</span> PORT = <span class="keyword">await</span> getPort(&#123; <span class="attr">port</span>: [<span class="number">3000</span>, <span class="number">4000</span>, <span class="number">8080</span>, <span class="number">8888</span>] &#125;);</span><br><span class="line">    <span class="keyword">const</span> address = <span class="string">`http://<span class="subst">$&#123;HOST&#125;</span>:<span class="subst">$&#123;PORT&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载 webpack 配置</span></span><br><span class="line">    <span class="keyword">const</span> compiler = webpack(devConfig);</span><br><span class="line">    openBrowser(compiler, address);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> devServer = express();</span><br><span class="line">    setupMiddlewares(compiler, devServer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> httpServer = devServer.listen(PORT, HOST, err =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="built_in">console</span>.error(err);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// logSymbols.success 在 windows 平台渲染为 √ ，支持的平台会显示 ✔</span></span><br><span class="line">        <span class="built_in">console</span>.log(</span><br><span class="line">            <span class="string">`DevServer is running at <span class="subst">$&#123;chalk.magenta.underline(address)&#125;</span> <span class="subst">$&#123;logSymbols.success&#125;</span>`</span>,</span><br><span class="line">        );</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 我们监听了 node 信号，所以使用 cross-env-shell 而不是 cross-env</span></span><br><span class="line">    <span class="comment">// 参考：https://github.com/kentcdodds/cross-env#cross-env-vs-cross-env-shell</span></span><br><span class="line">    [<span class="string">'SIGINT'</span>, <span class="string">'SIGTERM'</span>].forEach(<span class="function">(<span class="params">signal: any</span>) =&gt;</span> &#123;</span><br><span class="line">        process.on(signal, () =&gt; &#123;</span><br><span class="line">            <span class="comment">// 先关闭 devServer</span></span><br><span class="line">            httpServer.close();</span><br><span class="line">            <span class="comment">// 在 ctrl + c 的时候随机输出 'See you again' 和 'Goodbye'</span></span><br><span class="line">            <span class="built_in">console</span>.log(</span><br><span class="line">                chalk.greenBright.bold(<span class="string">`\n<span class="subst">$&#123;<span class="built_in">Math</span>.random() &gt; <span class="number">0.5</span> ? <span class="string">'See you again'</span> : <span class="string">'Goodbye'</span>&#125;</span>!`</span>),</span><br><span class="line">            );</span><br><span class="line">            <span class="comment">// 退出 node 进程</span></span><br><span class="line">            process.exit();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写过 python 的人应该不会陌生这种写法</span></span><br><span class="line"><span class="comment">// require.main === module 判断这个模块是不是被直接运行的</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">require</span>.main === <span class="built_in">module</span>) &#123;</span><br><span class="line">    start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>webpackHotMiddleware</code> 的 <code>overlay</code> 选项是用于是否开启错误遮罩：</p><p><img data-src="https://i.loli.net/2020/02/20/lLQEXfwgY5khOeM.png" alt="overlay"></p><p>很多细节我都写到注释里面了，安装其中用到的一些工具库：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add get-port <span class="built_in">log</span>-symbols open yarg -D</span><br></pre></td></tr></table></figure><p>前三个都是 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NpbmRyZXNvcmh1cw==" title="https://github.com/sindresorhus">sindresorhus<i class="fa fa-external-link"></i></span> 大佬的作品，<code>get-port</code> 用于获取可用端口，<code>log-symbols</code> 提供了下面四个 log 字符，<code>open</code> 用于系统应用打开 <code>uri</code> （<code>uri</code> 包括文件和网址大家应该都知道）, <code>yargs</code> 用于解析命令行参数。</p><p><img data-src="https://github.com/sindresorhus/log-symbols/raw/master/screenshot.png" alt="log-symbols"></p><p><code>webpack-dev-middleware</code> 并不支持 <code>webpack-dev-server</code> 中的 <code>historyFallback</code> 和 <code>proxy</code> 功能，其实无所谓，我们可以通过 <strong>DIY</strong> 我们的 express server 来实现，我们甚至可以使用 <code>express</code> 来集成 <code>mock</code> 功能。安装对应的两个中间件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add connect-history-api-fallback http-proxy-middleware @types/connect-history-api-fallback @types/http-proxy-middleware -D</span><br></pre></td></tr></table></figure><p><code>connect-history-api-fallback</code> 可以直接作为 <code>express</code> 中间件集成到 express server，封装一下 <code>http-proxy-middleware</code>，可以在 <code>proxyTable</code> 中添加自己的代理配置：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createProxyMiddleware &#125; <span class="keyword">from</span> <span class="string">'http-proxy-middleware'</span>;</span><br><span class="line"><span class="keyword">import</span> chalk <span class="keyword">from</span> <span class="string">'chalk'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Express &#125; <span class="keyword">from</span> <span class="string">'express'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Options &#125; <span class="keyword">from</span> <span class="string">'http-proxy-middleware/dist/types'</span>;</span><br><span class="line"></span><br><span class="line">interface ProxyTable &#123;</span><br><span class="line">    [path: string]: Options;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> proxyTable: ProxyTable = &#123;</span><br><span class="line">    <span class="comment">// 示例配置</span></span><br><span class="line">    <span class="string">'/path_to_be_proxy'</span>: &#123; <span class="attr">target</span>: <span class="string">'http://target.domain.com'</span>, <span class="attr">changeOrigin</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修饰链接的辅助函数, 修改颜色并添加下划线</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderLink</span>(<span class="params">str: string</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> chalk.magenta.underline(str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">proxy</span>(<span class="params">server: Express</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">Object</span>.entries(proxyTable).forEach(<span class="function">(<span class="params">[path, options]</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">from</span> = path;</span><br><span class="line">        <span class="keyword">const</span> to = options.target <span class="keyword">as</span> string;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`proxy <span class="subst">$&#123;renderLink(<span class="keyword">from</span>)&#125;</span> <span class="subst">$&#123;chalk.green(<span class="string">'-&gt;'</span>)&#125;</span> <span class="subst">$&#123;renderLink(to)&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// eslint-disable-next-line no-param-reassign</span></span><br><span class="line">        <span class="keyword">if</span> (!options.logLevel) options.logLevel = <span class="string">'warn'</span>;</span><br><span class="line">        server.use(path, createProxyMiddleware(options));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果需要更灵活的定义方式，请在下面直接使用 server.use(path, proxyMiddleware(options)) 定义</span></span><br><span class="line">    &#125;);</span><br><span class="line">    process.stdout.write(<span class="string">'\n'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> proxy;</span><br></pre></td></tr></table></figure><p>为了启动 devServer，我们还需要安装两个命令行工具：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add ts-node cross-env -D</span><br></pre></td></tr></table></figure><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1R5cGVTdHJvbmcvdHMtbm9kZQ==" title="https://github.com/TypeStrong/ts-node">ts-node<i class="fa fa-external-link"></i></span> 可以让我们直接运行 TypeScript 代码，<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2tlbnRjZG9kZHMvY3Jvc3MtZW52Lw==" title="https://github.com/kentcdodds/cross-env/">cross-env<i class="fa fa-external-link"></i></span> 是一个跨操作系统的设置环境变量的工具，添加启动命令到 npm script：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// package.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"scripts"</span>: &#123;</span><br><span class="line">        <span class="string">"start"</span>: <span class="string">"cross-env-shell NODE_ENV=development ts-node --files -P ./scripts/tsconfig.json ./scripts/start.ts --open"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2tlbnRjZG9kZHMvY3Jvc3MtZW52LyNjcm9zcy1lbnYtdnMtY3Jvc3MtZW52LXNoZWxs" title="https://github.com/kentcdodds/cross-env/#cross-env-vs-cross-env-shell">cross-env<i class="fa fa-external-link"></i></span> 官方文档提到如果要在 windows 平台处理 node 信号例如 <code>SIGINT</code>，也就是我们 <code>ctrl + c</code> 时触发的信号应该使用 <code>cross-env-shell</code> 命令而不是 <code>cross-env</code> 。</p><p>ts-node 为了提高执行速度，默认不会读取 <code>tsconfig.json</code> 中的 <code>files</code>, <code>include</code> 和 <code>exclude</code> 字段，而是基于模块依赖读取的。这会导致我们后面写的一些全局的 <code>.d.ts</code> 文件不会被读取，为此，我们需要指定 <code>--files</code> 参数，详情可以查看 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1R5cGVTdHJvbmcvdHMtbm9kZSNoZWxwLW15LXR5cGVzLWFyZS1taXNzaW5n" title="https://github.com/TypeStrong/ts-node#help-my-types-are-missing">help-my-types-are-missing<i class="fa fa-external-link"></i></span>。我们的 node 代码并不多，而且又不是经常性重启项目，直接让 ts-node 扫描整个 <code>scripts</code> 文件夹没多大影响。</p><p>启动我们的 dev server，通过 ctrl + c 退出：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm start</span><br></pre></td></tr></table></figure><p><img data-src="https://i.loli.net/2020/02/16/DevliamMEKy1hTt.gif" alt="dev server"></p><h2 id="开发环境优化"><a href="#开发环境优化" class="headerlink" title="开发环境优化"></a>开发环境优化</h2><h3 id="plugins"><a href="#plugins" class="headerlink" title="plugins"></a>plugins</h3><p>每个 webpack plugin 都是一个包含 apply 方法的 class，在我们调用 <code>compiler.run</code> 或者 <code>compiler.watch</code> 的时候它就会被调用，并且把 compiler 作为参数传它。compiler 对象提供了各个时期的 hooks，我们可以通过这些 hooks 挂载回调函数来实现各种功能，例如压缩，优化统计信息，在在编译完弹个编译成功的通知等。</p><p><img data-src="https://i.loli.net/2020/02/17/kqngMuoNQWj2CyG.png" alt="hooks"></p><h4 id="显示打包进度"><a href="#显示打包进度" class="headerlink" title="显示打包进度"></a>显示打包进度</h4><p><code>webpack-dev-server</code> 在打包时使用 <code>--progress</code> 参数会在控制台实时输出百分比表示当前的打包进度，但是从上面的图中可以看出只是输出了一些统计信息（stats）。想要实时显示打包进度我了解的有三种方式：</p><ol><li><p>webpack 内置的 <span class="exturl" data-url="aHR0cHM6Ly93ZWJwYWNrLmRvY3NjaGluYS5vcmcvcGx1Z2lucy9wcm9ncmVzcy1wbHVnaW4=" title="https://webpack.docschina.org/plugins/progress-plugin">webpack.ProgressPlugin<i class="fa fa-external-link"></i></span> 插件</p></li><li><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NsZXNzZy9wcm9ncmVzcy1iYXItd2VicGFjay1wbHVnaW4=" title="https://github.com/clessg/progress-bar-webpack-plugin">progress-bar-webpack-plugin<i class="fa fa-external-link"></i></span></p></li><li><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL251eHQvd2VicGFja2Jhcg==" title="https://github.com/nuxt/webpackbar">webpackbar<i class="fa fa-external-link"></i></span></p></li></ol><p>内置的 <code>ProgressPlugig</code> 非常的原始，你可以在回调函数获取当前进度，然后按照自己喜欢的格式去打印：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> handler = <span class="function">(<span class="params">percentage, message, ...args</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// e.g. Output each progress message directly to the console:</span></span><br><span class="line">  <span class="built_in">console</span>.info(percentage, message, ...args);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">new</span> webpack.ProgressPlugin(handler);</span><br></pre></td></tr></table></figure><p><code>progress-bar-webpack-plugin</code> 这个插件不是显示百分比，而是显示一个用字符画出来的进度条：</p><p><img data-src="https://camo.githubusercontent.com/cb9c82719765ad966a2771f084175c9ec935124e/687474703a2f2f692e696d6775722e636f6d2f4f495031676e6a2e676966" alt="progress-bar-webpack-plugin"></p><p>这个插件其实还是挺简洁实用的，但是有个 bug ，如果在打印进度条的时候输出了其它语句，进度条就会错位，我们的 devServer 会在启动后会输出地址：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">`DevServer is running at <span class="subst">$&#123;chalk.magenta.underline(address)&#125;</span> <span class="subst">$&#123;logSymbols.success&#125;</span>`</span>);</span><br></pre></td></tr></table></figure><p>使用这个进度条插件就会出问题下面的问题，遂放弃。</p><p><img data-src="https://i.loli.net/2020/02/16/MvEgi4sw7WkjbnT.png" alt="progress-bar-webpack-plugin"></p><p><code>webpackbar</code> 是 nuxt project 下的库，背靠 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL251eHQ=" title="https://github.com/nuxt">nuxt<i class="fa fa-external-link"></i></span>，质量绝对有保证。我之前有段时间用的是 <code>progress-bar-webpack-plugin</code>，因为我在 npm 官网搜索 <code>webpack progress</code>，综合看下来就它比较靠谱，<code>webpackbar</code> 都没搜出来。 看了下 <code>webpackbar</code> 的 <code>package.json</code>，果然 <code>keywords</code> 都是空的。<code>webpackBar</code> 还是我在研究 <code>ant design</code> 的 webpack 配置看到它用了这个插件，才发现了这个宝藏：</p><p><img data-src="https://i.loli.net/2020/02/19/MGDZLJBcK2yToN6.png" alt="webpackbar"></p><p>安装 <code>webpackbar</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add webpackbar @types/webpackbar -D</span><br></pre></td></tr></table></figure><p>添加配置到 <code>webpack.common.ts</code> 的 plugins 数组，颜色我们使用 react 蓝：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Configuration &#125; <span class="keyword">from</span> <span class="string">'webpack'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> commonConfig: Configuration = &#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> WebpackBar(&#123;</span><br><span class="line">      name: <span class="string">'react-typescript-boilerplate'</span>,</span><br><span class="line">      <span class="comment">// react 蓝</span></span><br><span class="line">      color: <span class="string">'#61dafb'</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="优化控制台输出"><a href="#优化控制台输出" class="headerlink" title="优化控制台输出"></a>优化控制台输出</h4><p>我们使用 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dlb3dhcmluL2ZyaWVuZGx5LWVycm9ycy13ZWJwYWNrLXBsdWdpbg==" title="https://github.com/geowarin/friendly-errors-webpack-plugin">friendly-errors-webpack-plugin<i class="fa fa-external-link"></i></span> 插件让控制台的输出更加友好，下面使用了之后编译成功时的效果：</p><p><img data-src="https://i.loli.net/2020/02/19/bj9hRKeUBMG1Hmv.png" alt="build successful"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add friendly-errors-webpack-plugin @types/friendly-errors-webpack-plugin -D</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.common.ts</span></span><br><span class="line"><span class="keyword">import</span> FriendlyErrorsPlugin <span class="keyword">from</span> <span class="string">'friendly-errors-webpack-plugin'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> commonConfig: Configuration = &#123;</span><br><span class="line">  plugins: [<span class="keyword">new</span> FriendlyErrorsPlugin()],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="构建通知"><a href="#构建通知" class="headerlink" title="构建通知"></a>构建通知</h4><p><img data-src="https://i.loli.net/2020/02/19/wsWuPkh3x9GlL4a.png" alt="build notification"></p><p>在我大四实习之前，我就没完整写过 vue 项目的，在上家公司实习的那段时间主要就是写 vue，当时我对 vue-cli 那个频繁的错误通知很反感，我和同事说我想去掉这个通知，没曾想同事都是比较喜欢那个通知，既然有人需要，那我们这个项目也配一下。</p><p>我们使用 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1JvY2NvQy93ZWJwYWNrLWJ1aWxkLW5vdGlmaWVy" title="https://github.com/RoccoC/webpack-build-notifier">webpack-build-notifier<i class="fa fa-external-link"></i></span> 来支持错误通知，这个插件是 TypeScript 写的，不需要安装 types：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add webpack-build-notifier -D</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.common.ts</span></span><br><span class="line"><span class="keyword">import</span> WebpackBuildNotifierPlugin <span class="keyword">from</span> <span class="string">'webpack-build-notifier'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> commonConfig: Configuration = &#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="comment">// suppressSuccess: true 设置只在第一次编译成功时输出成功的通知, rebuild 成功的时候不通知</span></span><br><span class="line">    <span class="keyword">new</span> WebpackBuildNotifierPlugin(&#123; <span class="attr">suppressSuccess</span>: <span class="literal">true</span> &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>因为我不喜欢弹通知，所以模板项目中的我注释掉了这个插件，有需要的自己打开就行了。</p></blockquote><h4 id="严格检查路径大小写"><a href="#严格检查路径大小写" class="headerlink" title="严格检查路径大小写"></a>严格检查路径大小写</h4><p>下面的测试表明 webpack 默认对路径的大小写不敏感：</p><p><img data-src="https://i.loli.net/2020/02/16/czN2UDhGiXb3TJ5.png" alt="path case"></p><p>我们使用 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1VydGhlbi9jYXNlLXNlbnNpdGl2ZS1wYXRocy13ZWJwYWNrLXBsdWdpbg==" title="https://github.com/Urthen/case-sensitive-paths-webpack-plugin">case-sensitive-paths-webpack-plugin<i class="fa fa-external-link"></i></span> 对路径进行严格的大小写检查：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add <span class="keyword">case</span>-sensitive-paths-webpack-plugin @types/<span class="keyword">case</span>-sensitive-paths-webpack-plugin -D</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.common.ts</span></span><br><span class="line"><span class="keyword">import</span> CaseSensitivePathsPlugin <span class="keyword">from</span> <span class="string">'case-sensitive-paths-webpack-plugin'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> commonConfig: Configuration = &#123;</span><br><span class="line">  plugins: [<span class="keyword">new</span> CaseSensitivePathsPlugin()],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img data-src="https://i.loli.net/2020/02/16/FWdazBElvG8Mq4U.png" alt="path-case-check"></p><p>实际打包测试中发现这个插件非常耗时，并且因为 <code>eslint-import-plugin</code> 默认会对只是大小写不一样的模块路径会报错，因此我们这个项目就不集成了。</p><p><img data-src="https://i.loli.net/2020/04/03/3fLepM1GSBAPjh4.png" alt="case sensitive"></p><h4 id="循环依赖检查"><a href="#循环依赖检查" class="headerlink" title="循环依赖检查"></a>循环依赖检查</h4><p><img data-src="https://i.loli.net/2020/02/16/bHQEPLK1WiCXlBA.png" alt="circle-dependencies"></p><p>webpack 默认不会对循环依赖报错，通过 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FhY2tlcm1hbi9jaXJjdWxhci1kZXBlbmRlbmN5LXBsdWdpbg==" title="https://github.com/aackerman/circular-dependency-plugin">circular-dependency-plugin <i class="fa fa-external-link"></i></span>这个 webpack 插件可以帮我们及时发现循环依赖的问题：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add circular-dependency-plugin @types/circular-dependency-plugin -D</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.common.ts</span></span><br><span class="line"><span class="keyword">import</span> CircularDependencyPlugin <span class="keyword">from</span> <span class="string">'circular-dependency-plugin'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; projectRoot, resolvePath &#125; <span class="keyword">from</span> <span class="string">'../env'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> commonConfig: Configuration = &#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> CircularDependencyPlugin(&#123;</span><br><span class="line">      exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">      failOnError: <span class="literal">true</span>,</span><br><span class="line">      allowAsyncCycles: <span class="literal">false</span>,</span><br><span class="line">      cwd: projectRoot,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img data-src="https://i.loli.net/2020/02/16/VOxjym6zZFftkhr.png" alt="circle dependencies error"></p><p>这里顺便提一下 <code>cwd</code> 也就是工作路径的问题，官方文档直接用 <code>process.cwd()</code>，这是一种不好的做法，项目路径和工作路径是不同的两个概念。在 node 中表示项目路径永远不要用 <code>preocess.cwd()</code>，因为总会有些沙雕用户不去项目根目录启动。<code>process.cwd()</code> 也就是工作路径返回的是你运行 node 时所在的路径，假设说项目在 <code>/code/projectRoot</code>，有些用户直接在系统根目录打开 terminal，来一句 <code>node ./code/projectRoot/index.js</code>，这时 <code>index.js</code> 中 <code>process.cwd()</code> 返回的是就是系统根路径 <code>/</code>，不是有些人认为的还是 <code>/code/projectRoot</code>。</p><p>获取项目路径应该使用 <code>path.resolve</code>：</p><p><img data-src="https://i.loli.net/2020/02/19/4wW75dVszApkQGe.png" alt="project root"></p><p>这个问题 eslint-import-plugin 也会报错，并且在 TypeScript 项目中有时候就是需要循环导入文件，因此也不集成。</p><h4 id="清理上次打包的-bundle"><a href="#清理上次打包的-bundle" class="headerlink" title="清理上次打包的 bundle"></a>清理上次打包的 bundle</h4><p>前面介绍了一些花里胡哨的插件，也介绍了一些让我们项目保持健康的插件，现在我们开始介绍一些打包用的插件。</p><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2pvaG5hZ2FuL2NsZWFuLXdlYnBhY2stcGx1Z2lu" title="https://github.com/johnagan/clean-webpack-plugin">clean-webpack-plugin<i class="fa fa-external-link"></i></span> 它会在第一次编译的时候删除 <code>dist</code> 目录中所有的文件，不过会保留 <code>dist</code> 文件夹，并且再每次 <code>rebuild</code> 的时候会删除所有不再被使用的文件。</p><p>这个项目也是 TypeScript 写的，总感觉 TypeScript 写的项目有种莫名的踏实感：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add clean-webpack-plugin -D</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.common.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; CleanWebpackPlugin &#125; <span class="keyword">from</span> <span class="string">'clean-webpack-plugin'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> commonConfig: Configuration = &#123;</span><br><span class="line">  plugins: [<span class="keyword">new</span> CleanWebpackPlugin()],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="自动生成-index-html"><a href="#自动生成-index-html" class="headerlink" title="自动生成 index.html"></a>自动生成 index.html</h4><p>众所周知，腾讯的前端面试很喜欢考计算机网络，我曾多次被问到过如何更新强缓存的问题。解决强缓存立即更新的问题我们一般就是采取在文件名中插入文件内容的 hash 值，然后首页不使用强缓存。这样只要你更新了某个被强缓存的资源文件，由于更新后内容的 hash 值会变化，生成的文件名也会变化，这样你请求首页的时候由于访问的是一个新的资源路径，就会向服务器请求最新的资源。关于浏览器 HTTP 缓存可以看我另一篇文章：<a href="https://lyreal666.com/通过-koa2-服务器实践探究浏览器HTTP缓存机制/">通过-koa2-服务器实践探究浏览器 HTTP 缓存机制</a>。</p><p>我们后续优化生产环境构建的时候会对将 CSS 拆分成单独的文件，如果 index.html 中插入的引入外部样式的 <code>link</code> 标签的 <code>href</code> 是我们手动设置的，那每次修改样式文件，都会生成一个新的 hash 值，我们都要手动去修改这个路径，太麻烦了，更不要说在开发环境下文件是保存在内存文件系统的，你都看不到文件名。</p><p><img data-src="https://i.loli.net/2020/02/19/8OnBuWedj5z2CFP.png" alt="build hash"></p><p>使用 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2phbnRpbW9uL2h0bWwtd2VicGFjay1wbHVnaW4=" title="https://github.com/jantimon/html-webpack-plugin">html-webpack-plugin<i class="fa fa-external-link"></i></span> 可以自动生成 index.html，并且插入引用到的 bundle 和被拆分的 CSS 等资源路径。</p><p>参考 <code>creat-react-app</code> 的模板，我们新建 <code>public</code> 文件夹，并在其中加入 <code>index.html</code>，<code>favico.ico</code>，<code>manifest.json</code> 等文件。<code>public</code> 文件夹用于存放一些将被打包到 <code>dist</code> 文件夹一同发布的文件。</p><p>安装并配置 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2phbnRpbW9uL2h0bWwtd2VicGFjay1wbHVnaW4=" title="https://github.com/jantimon/html-webpack-plugin">html-webpack-plugin<i class="fa fa-external-link"></i></span>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add html-webpack-plugin @types/html-webpack-plugin -D</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> HtmlWebpackPlugin <span class="keyword">from</span> <span class="string">'html-webpack-plugin'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; __DEV__, projectName, resolvePath, projectRoot, hmrPath &#125; <span class="keyword">from</span> <span class="string">'../env'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> htmlMinifyOptions: HtmlMinifierOptions = &#123;</span><br><span class="line">    collapseWhitespace: <span class="literal">true</span>,</span><br><span class="line">    collapseBooleanAttributes: <span class="literal">true</span>,</span><br><span class="line">    collapseInlineTagWhitespace: <span class="literal">true</span>,</span><br><span class="line">    removeComments: <span class="literal">true</span>,</span><br><span class="line">    removeRedundantAttributes: <span class="literal">true</span>,</span><br><span class="line">    removeScriptTypeAttributes: <span class="literal">true</span>,</span><br><span class="line">    removeStyleLinkTypeAttributes: <span class="literal">true</span>,</span><br><span class="line">    minifyCSS: <span class="literal">true</span>,</span><br><span class="line">    minifyJS: <span class="literal">true</span>,</span><br><span class="line">    minifyURLs: <span class="literal">true</span>,</span><br><span class="line">    useShortDoctype: <span class="literal">true</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> commonConfig: Configuration = &#123;</span><br><span class="line">    output: &#123;</span><br><span class="line">        publicPath: <span class="string">'/'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">            <span class="comment">// HtmlWebpackPlugin 会调用 HtmlMinifier 对 HTMl 文件进行压缩</span></span><br><span class="line">            <span class="comment">// 只在生产环境压缩</span></span><br><span class="line">            minify: __DEV__ ? <span class="literal">false</span> : htmlMinifyOptions,</span><br><span class="line">            <span class="comment">// 指定 html 模板路径</span></span><br><span class="line">            template: resolvePath(projectRoot, <span class="string">'./public/index.html'</span>),</span><br><span class="line">            <span class="comment">// 类型不好定义，any 一时爽...</span></span><br><span class="line">            <span class="comment">// 定义一些可以在模板中访问的模板参数</span></span><br><span class="line">            templateParameters: <span class="function">(<span class="params">...args: any[]</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> [compilation, assets, assetTags, options] = args;</span><br><span class="line">                <span class="keyword">const</span> rawPublicPath = commonConfig.output!.publicPath!;</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    compilation,</span><br><span class="line">                    webpackConfig: compilation.options,</span><br><span class="line">                    htmlWebpackPlugin: &#123;</span><br><span class="line">                        tags: assetTags,</span><br><span class="line">                        files: assets,</span><br><span class="line">                        options,</span><br><span class="line">                    &#125;,</span><br><span class="line">        			<span class="comment">// 除掉 publicPath 的反斜杠，让用户在模板中拼接路径更自然</span></span><br><span class="line">                    PUBLIC_PATH: rawPublicPath.endsWith(<span class="string">'/'</span>)</span><br><span class="line">                        ? rawPublicPath.slice(<span class="number">0</span>, <span class="number">-1</span>)</span><br><span class="line">                        : rawPublicPath,</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;),</span><br><span class="line">    ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>为了让用户可以像 <code>create-react-app</code> 一样在 <code>index.html</code> 里面通过 <code>PUBLIC_PATH</code> 访问发布路径，需要配置 <code>templateParameters</code> 选项添加 <code>PUBLIC_PATH</code> 变量到模板参数，<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2phbnRpbW9uL2h0bWwtd2VicGFjay1wbHVnaW4=" title="https://github.com/jantimon/html-webpack-plugin">html-webpack-plugin<i class="fa fa-external-link"></i></span> 默认支持部分 ejs 语法，我们可以通过下面的方式动态设置 <code>favicon.ico</code> , <code>mainfest.json</code> 等资源路径：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"icon"</span> <span class="attr">href</span>=<span class="string">"&lt;%= `$&#123;PUBLIC_PATH&#125;/favicon.ico` %&gt;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"apple-touch-icon"</span> <span class="attr">href</span>=<span class="string">"&lt;%= `$&#123;PUBLIC_PATH&#125;/logo192.png` %&gt;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"manifest"</span> <span class="attr">href</span>=<span class="string">"&lt;%= `$&#123;PUBLIC_PATH&#125;/manifest.json` %&gt;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>React App<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">noscript</span>&gt;</span>You need to enable JavaScript to run this app.<span class="tag">&lt;/<span class="name">noscript</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"root"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="拷贝文件到-dist"><a href="#拷贝文件到-dist" class="headerlink" title="拷贝文件到 dist"></a>拷贝文件到 dist</h4><p><code>public</code> 文件夹中有一些文件例如 <code>favico.icon</code> 和 <code>mainfest.json</code> 需要被拷贝到 <code>dist</code> 文件夹，我们可以使用 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dlYnBhY2stY29udHJpYi9jb3B5LXdlYnBhY2stcGx1Z2lu" title="https://github.com/webpack-contrib/copy-webpack-plugin">copy-webpack-plugin<i class="fa fa-external-link"></i></span> 在使用 devServer 的情况下将文件拷贝到内存文件系统，在生产环境构建的时拷贝到磁盘：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add copy-webpack-plugin @types/copy-webpack-plugin -D</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.common.ts</span></span><br><span class="line"><span class="keyword">import</span> CopyPlugin <span class="keyword">from</span> <span class="string">'copy-webpack-plugin'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> commonConfig: Configuration = &#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> CopyPlugin(</span><br><span class="line">      [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">// 所有一级文件</span></span><br><span class="line">          <span class="keyword">from</span>: <span class="string">'*'</span>,</span><br><span class="line">          to: resolvePath(projectRoot, <span class="string">'./dist'</span>),</span><br><span class="line">          <span class="comment">// 目标类型是文件夹</span></span><br><span class="line">          toType: <span class="string">'dir'</span>,</span><br><span class="line">          <span class="comment">// index.html 会通过 html-webpack-plugin 自动生成，所以需要被忽略掉</span></span><br><span class="line">          ignore: [<span class="string">'index.html'</span>],</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">      &#123; <span class="attr">context</span>: resolvePath(projectRoot, <span class="string">'./public'</span>) &#125;</span><br><span class="line">    ),</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="检查-TypeScript-类型"><a href="#检查-TypeScript-类型" class="headerlink" title="检查 TypeScript 类型"></a>检查 TypeScript 类型</h4><p>babel 为了提高编译速度只支持 TypeScript 语法编译而不支持类型检查，为了在 webpack 打包的同时支持 ts 类型检查，我们会使用 webpack 插件 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1R5cGVTdHJvbmcvZm9yay10cy1jaGVja2VyLXdlYnBhY2stcGx1Z2lu" title="https://github.com/TypeStrong/fork-ts-checker-webpack-plugin">fork-ts-checker-webpack-plugin<i class="fa fa-external-link"></i></span>，这个 webpack 插件会在一个单独的进程并行的进行 TypeScript 的类型检查，这个项目也是 TypeScript 写的，我们不需要安装 types。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add fork-ts-checker-webpack-plugin -D</span><br></pre></td></tr></table></figure><p>添加到 <code>webpack.dev.ts</code>，限制使用的内存为 1G：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ForkTsCheckerWebpackPlugin <span class="keyword">from</span> <span class="string">'fork-ts-checker-webpack-plugin'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> devConfig = merge(commonConfig, &#123;</span><br><span class="line">  mode: <span class="string">'development'</span>,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> ForkTsCheckerWebpackPlugin(&#123;</span><br><span class="line">      memoryLimit: <span class="number">1024</span>,</span><br><span class="line">      <span class="comment">// babel 转换的是我们前端代码，所以是指向前端代码的 tsconfig.json</span></span><br><span class="line">      tsconfig: resolvePath(projectRoot, <span class="string">'./src/tsconfig.json'</span>),</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>同时修改 <code>webpack.prod.ts</code>，因为我们生产环境构建并不会长时间的占用内存，所以可以调大点，我们就默认限制生产环境的构建使用的内存为 2G：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.prod.ts</span></span><br><span class="line"><span class="keyword">const</span> prodConfig = merge(commonConfig, &#123;</span><br><span class="line">  mode: <span class="string">'production'</span>,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> ForkTsCheckerWebpackPlugin(&#123;</span><br><span class="line">      memoryLimit: <span class="number">1024</span> * <span class="number">2</span>,</span><br><span class="line">      tsconfig: resolvePath(projectRoot, <span class="string">'./src/tsconfig.json'</span>),</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="缓存神器"><a href="#缓存神器" class="headerlink" title="缓存神器"></a>缓存神器</h4><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL216Z29kZGFyZC9oYXJkLXNvdXJjZS13ZWJwYWNrLXBsdWdpbg==" title="https://github.com/mzgoddard/hard-source-webpack-plugin">hard-source-webpack-plugin<i class="fa fa-external-link"></i></span> 是一个给 <code>modules</code> 提供中间缓存步骤的 webpack 插件，为了看到效果我们可能需要运行两次，第一次就是正常的编译速度，第二次可能会快上很多倍，拿我开发的一个 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RqeDY2Ni92aWV3LWdpdGh1Yi1yZXBvc2l0b3J5" title="https://github.com/tjx666/view-github-repository">VSCode 插件 <i class="fa fa-external-link"></i></span>来测试一下：</p><p>我先把 <code>node_modules/.cache/hard-source</code> 缓存文件夹删掉，看看没有缓存的时候编译速度：</p><p><img data-src="https://i.loli.net/2020/02/17/ZucCU1dEev372bS.png" alt="no cache"></p><p>耗时 3.075 秒，重新编译：</p><p><img data-src="https://i.loli.net/2020/02/17/q5B6kUFSm3TyiLl.png" alt="cache"></p><p>哇 🚀，直接快了 3.6 倍多…</p><p>实测发现这个插件在初次打包会耗时严重，并且即将发布的 webpack5 将内置这个功能，具体可以看这个 issue: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dlYnBhY2svd2VicGFjay9pc3N1ZXMvNjUyNw==" title="https://github.com/webpack/webpack/issues/6527">[spec: webpack 5] - A module disk cache between build processes <i class="fa fa-external-link"></i></span>。因此我们这个项目就不集成这个插件了。</p><p>好了，插件部分介绍完了，接下来开始配置 loaders ！</p><h3 id="loaders"><a href="#loaders" class="headerlink" title="loaders"></a>loaders</h3><p>webpack 默认只支持导入 js，处理不了其它文件，需要配置对应的 loader，像 <code>excel-loader</code> 就可以解析 excel 为一个对象，<code>file-loader</code> 可以解析 png 图片为最终的发布路径。loader 是作用于一类文件的，plugin 是作用于 webpack 编译的各个时期。</p><p>前面我们只配置了 <code>babel-loader</code>， 使得 webpack 能够处理 TypeScript 文件，实际的开发中我们还需要支持导入样式文件，图片文件，字体文件等。</p><h4 id="处理样式文件"><a href="#处理样式文件" class="headerlink" title="处理样式文件"></a>处理样式文件</h4><p>我们最终要达到的目标是支持 css/less/sass 三种语法，以及通过 <code>postcss</code> 和 <code>autoprefixer</code> 插件实现自动补齐浏览器头等功能。</p><h5 id="CSS"><a href="#CSS" class="headerlink" title="CSS"></a>CSS</h5><p>处理 css 文件我们需要安装 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dlYnBhY2stY29udHJpYi9zdHlsZS1sb2FkZXI=" title="https://github.com/webpack-contrib/style-loader">style-loader<i class="fa fa-external-link"></i></span> 和 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dlYnBhY2stY29udHJpYi9jc3MtbG9hZGVy" title="https://github.com/webpack-contrib/css-loader">css-loader<i class="fa fa-external-link"></i></span>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add css-loader style-loader -D</span><br></pre></td></tr></table></figure><p><code>css-loader</code> 作用是处理 CSS 文件中的 <code>@import</code> 和 <code>url()</code> 返回一个合并后的 CSS 字符串，而 <code>style-loader</code> 负责将返回的 CSS 字符串用 <code>style</code> 标签插到 DOM 中，并且还实现了 webpack 的热更新接口。</p><p><code>style-loader</code> 官方示例配置是这样的：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// i 后缀忽略大小写</span></span><br><span class="line">        test: <span class="regexp">/\.css$/i</span>,</span><br><span class="line">        use: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>可以看到匹配正则用了 <code>i</code> 后缀，我觉得这样不好，不应该提高一些无意义的容错率，用<code>.CSS</code> 做后缀就不应该让 webpack 编译通过。我们知道 webpack 的 loaders 加载顺序是从右到左的，所以需要先执行的 <code>css-loader</code> 应该在后执行的 <code>style-loader</code> 后面：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.common.ts</span></span><br><span class="line"><span class="keyword">const</span> commonConfig: Configuration = &#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          <span class="string">'style-loader'</span>,</span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">'css-loader'</span>,</span><br><span class="line">            options: &#123;</span><br><span class="line">              <span class="comment">// CSS modules 比较耗性能，默认就是禁用的</span></span><br><span class="line">              modules: <span class="literal">false</span>,</span><br><span class="line">              <span class="comment">// 开启 sourcemap</span></span><br><span class="line">              sourceMap: <span class="literal">true</span>,</span><br><span class="line">              <span class="comment">// 指定在 CSS loader 处理前使用的 laoder 数量</span></span><br><span class="line">              importLoaders: <span class="number">0</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="less"><a href="#less" class="headerlink" title="less"></a>less</h5><p><code>less-loader</code> 依赖 <code>less</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add less less-loader -D</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.common.ts</span></span><br><span class="line"><span class="keyword">const</span> commonConfig: Configuration = &#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.less$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          <span class="string">'style-loader'</span>,</span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">'css-loader'</span>,</span><br><span class="line">            options: &#123;</span><br><span class="line">              modules: <span class="literal">false</span>,</span><br><span class="line">              sourceMap: <span class="literal">true</span>,</span><br><span class="line">              <span class="comment">// 需要先被 less-loader 处理，所以这里设置为 1</span></span><br><span class="line">              importLoaders: <span class="number">1</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="comment">// 先让 less-loader 将 less 文件转换成 css 文件</span></span><br><span class="line">            <span class="comment">// 再交给 css-loader 处理</span></span><br><span class="line">            loader: <span class="string">'less-loader'</span>,</span><br><span class="line">            options: &#123;</span><br><span class="line">              sourceMap: <span class="literal">true</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="sass"><a href="#sass" class="headerlink" title="sass"></a>sass</h5><p>其实我本人从来不用 <code>less</code> 和 <code>stylus</code>，我一直用的是 <code>sass</code>。<code>sass</code> 有两种语法格式，通过后缀名区分。<code>.sass</code> 后缀名是类似 <code>yml</code> 的缩进写法，<code>.scss</code> 是类似于 CSS 的花括号写法，不过支持嵌套和变量等特性。鉴于我基本上没看过哪个项目用 <code>yml</code> 格式的写法，用的人太少了，我们模板就只支持 <code>scss</code> 后缀好了。<code>sass-loader</code> 同样依赖 <code>node-sass</code>，<code>node-sass</code> 真是个碧池，没有代理还安装不了，所以我在系列第一篇就在 <code>.npmrc</code> 就配置了 <code>node-sass</code> 的镜像：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add node-sass sass-loader -D</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.common.ts</span></span><br><span class="line"><span class="keyword">const</span> commonConfig: Configuration = &#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          <span class="string">'style-loader'</span>,</span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">'css-loader'</span>,</span><br><span class="line">            options: &#123;</span><br><span class="line">              modules: <span class="literal">false</span>,</span><br><span class="line">              sourceMap: <span class="literal">true</span>,</span><br><span class="line">              importLoaders: <span class="number">1</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">'sass-loader'</span>,</span><br><span class="line">            options: &#123;</span><br><span class="line">              <span class="comment">// 中间每个 loader 都要开启 sourcemap，才能生成正确的 soucemap</span></span><br><span class="line">              sourceMap: <span class="literal">true</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="postcss"><a href="#postcss" class="headerlink" title="postcss"></a>postcss</h5><p><img data-src="https://i.loli.net/2020/02/20/Mxsl8rQdU1tNiYm.png" alt="browser prefix"></p><p>记得我在大一上网页设计课学到 CSS3 的时候，很多属性都要加浏览器头处理兼容性，当时就对 CSS 兴趣大减，太麻烦了。自从 node 的出现，前端工程化开始飞速发展，以前前端老被叫做切图仔，现在前端工程师也可以用 node 做伪全栈开发了。</p><p><strong>postcss</strong> 是 CSS 后处理器工具，因为先有 CSS，<code>postcss</code> 后去处理它，所以叫后处理器。</p><p><strong>less/sass</strong> 被称之为 CSS 预处理器，因为它们需要被 <code>less</code> 或 <code>node-sass</code> 预先编译代码到 CSS 嘛。</p><p>参考 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL2NyZWF0ZS1yZWFjdC1hcHAvYmxvYi9tYXN0ZXIvcGFja2FnZXMvcmVhY3Qtc2NyaXB0cy9jb25maWcvd2VicGFjay5jb25maWcuanMjTDk2" title="https://github.com/facebook/create-react-app/blob/master/packages/react-scripts/config/webpack.config.js#L96">create-react-app 对 postcss 的配置<i class="fa fa-external-link"></i></span>，安装以下插件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add postcss-loader postcss-flexbugs-fixes postcss-preset-env autoprefixer postcss-normalize -D</span><br></pre></td></tr></table></figure><p>添加 <code>postcss.config.js</code> 用于配置 <code>postcss</code>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="comment">// 修复一些和 flex 布局相关的 bug</span></span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'postcss-flexbugs-fixes'</span>),</span><br><span class="line">    <span class="comment">// 参考 browserslist 的浏览器兼容表自动对那些还不支持的现代 CSS 特性做转换</span></span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'postcss-preset-env'</span>)(&#123;</span><br><span class="line">      <span class="comment">// 自动添加浏览器头</span></span><br><span class="line">      autoprefixer: &#123;</span><br><span class="line">        <span class="comment">// will add prefixes only for final and IE versions of specification</span></span><br><span class="line">        flexbox: <span class="string">'no-2009'</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      stage: <span class="number">3</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="comment">// 根据 browserslist 自动导入需要的 normalize.css 内容</span></span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'postcss-normalize'</span>),</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>我们还需要添加 <code>browserslist</code> 配置到 <code>package.json</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// package.json</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"browserslist"</span>: [</span><br><span class="line">        <span class="string">"last 2 versions"</span>,</span><br><span class="line">        <span class="comment">// ESR（Extended Support Release） 长期支持版本</span></span><br><span class="line">        <span class="string">"Firefox ESR"</span>,</span><br><span class="line">        <span class="string">"&gt; 1%"</span>,</span><br><span class="line">        <span class="string">"ie &gt;= 11"</span></span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>回顾 CSS， less，sass 的配置可以看到有大量的重复，我们重构并修改 <code>importLoaders</code> 选项：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCssLoaders</span>(<span class="params">importLoaders: number</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    <span class="string">'style-loader'</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      loader: <span class="string">'css-loader'</span>,</span><br><span class="line">      options: &#123;</span><br><span class="line">        modules: <span class="literal">false</span>,</span><br><span class="line">        sourceMap: <span class="literal">true</span>,</span><br><span class="line">        importLoaders,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      loader: <span class="string">'postcss-loader'</span>,</span><br><span class="line">      options: &#123; <span class="attr">sourceMap</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> commonConfig: Configuration = &#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        use: getCssLoaders(<span class="number">1</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.less$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          <span class="comment">// postcss-loader + less-loader 两个 loader，所以 importLoaders 应该设置为 2</span></span><br><span class="line">          ...getCssLoaders(<span class="number">2</span>),</span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">'less-loader'</span>,</span><br><span class="line">            options: &#123;</span><br><span class="line">              sourceMap: <span class="literal">true</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          ...getCssLoaders(<span class="number">2</span>),</span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">'sass-loader'</span>,</span><br><span class="line">            options: &#123; <span class="attr">sourceMap</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="处理图片和字体"><a href="#处理图片和字体" class="headerlink" title="处理图片和字体"></a>处理图片和字体</h4><p>一般来说我们的项目在开发的时候会使用一些图片来测试效果，正式上线再替换成 CDN 而不是使用 webpack 打包的本地图片。处理文件的常用 loader 有俩，<code>file-loader</code> 和 <code>url-loader</code>，<code>file-loader</code> 用于解析导入的文件为发布时的 url， 并将文件输出到指定的位置，而后者是对前者的封装，提供了将低于阈值体积(下面就设置为 8192 个字节）的图片转换成 base64。我忽然想起以前腾讯的一个面试官问过这么个问题：使用 base64 有什么坏处吗？其实我觉得 base64 好处就是不用二次请求，坏处就是图片转 base64 体积反而会变大，变成原来的三分之四倍。</p><p><img data-src="https://i.loli.net/2020/02/20/IouO1Kvt5wFAWVl.png" alt="base64"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add url-loader -D</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> commonConfig: Configuration = &#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: [<span class="regexp">/\.bmp$/</span>, /\.gif$/, /\.jpe?g$/, /\.png$/],</span><br><span class="line">        use: [</span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">'url-loader'</span>,</span><br><span class="line">            options: &#123;</span><br><span class="line">              <span class="comment">// 图片低于 10k 会被转换成 base64 格式的 dataUrl</span></span><br><span class="line">              limit: <span class="number">10</span> * <span class="number">1024</span>,</span><br><span class="line">              <span class="comment">// [hash] 占位符和 [contenthash] 是相同的含义</span></span><br><span class="line">              <span class="comment">// 都是表示文件内容的 hash 值，默认是使用 md5 hash 算法</span></span><br><span class="line">              name: <span class="string">'[name].[contenthash].[ext]'</span>,</span><br><span class="line">              <span class="comment">// 保存到 images 文件夹下面</span></span><br><span class="line">              outputPath: <span class="string">'images'</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.(ttf|woff|woff2|eot|otf)$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">'url-loader'</span>,</span><br><span class="line">            options: &#123;</span><br><span class="line">              name: <span class="string">'[name]-[contenthash].[ext]'</span>,</span><br><span class="line">              outputPath: <span class="string">'fonts'</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>注意到我这里文件名中都插入了文件内容 hash 值，这样就可以解决<strong>强缓存需要立即更新</strong>的问题。</p><h3 id="sourcemap"><a href="#sourcemap" class="headerlink" title="sourcemap"></a>sourcemap</h3><table><thead><tr><th>devtool</th><th>构建速度</th><th>重新构建速度</th><th>生产环境</th><th>品质(quality)</th></tr></thead><tbody><tr><td>(none)</td><td>+++</td><td>+++</td><td>yes</td><td>打包后的代码</td></tr><tr><td>eval</td><td>+++</td><td>+++</td><td>no</td><td>生成后的代码</td></tr><tr><td>cheap-eval-source-map</td><td>+</td><td>++</td><td>no</td><td>转换过的代码（仅限行）</td></tr><tr><td>cheap-module-eval-source-map</td><td>o</td><td>++</td><td>no</td><td>原始源代码（仅限行）</td></tr><tr><td>eval-source-map</td><td>–</td><td>+</td><td>no</td><td>原始源代码</td></tr><tr><td>cheap-source-map</td><td>+</td><td>o</td><td>yes</td><td>转换过的代码（仅限行）</td></tr><tr><td>cheap-module-source-map</td><td>o</td><td>-</td><td>yes</td><td>原始源代码（仅限行）</td></tr><tr><td>inline-cheap-source-map</td><td>+</td><td>o</td><td>no</td><td>转换过的代码（仅限行）</td></tr><tr><td>inline-cheap-module-source-map</td><td>o</td><td>-</td><td>no</td><td>原始源代码（仅限行）</td></tr><tr><td>source-map</td><td>–</td><td>–</td><td>yes</td><td>原始源代码</td></tr><tr><td>inline-source-map</td><td>–</td><td>–</td><td>no</td><td>原始源代码</td></tr><tr><td>hidden-source-map</td><td>–</td><td>–</td><td>yes</td><td>原始源代码</td></tr><tr><td>nosources-source-map</td><td>–</td><td>–</td><td>yes</td><td>无源代码内容</td></tr></tbody></table><blockquote><p><code>+++</code> 非常快速, <code>++</code> 快速, <code>+</code> 比较快, <code>o</code> 中等, <code>-</code> 比较慢, <code>--</code> 慢</p></blockquote><p>sourcemap 是现在前端界很多工具必不可缺的一个功能，webpack，TypeScript，babel，powser-assert 等转换代码的工具都要提供 sourcemap 功能，源代码被压缩，混淆，polyfill，没有 sourcemap，根本没办法调试定位问题。</p><p>考虑到编译速度，调式友好性，我选择 <code>eval-source-map</code>，如果用户在打包时觉得慢，而且能够忍受没有列号，可以考虑调成 <code>cheap-eval-source-map</code>。</p><p>我们修改 <code>webpack.dev.ts</code> 的 devtool 为 <code>eval-source-map</code>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.dev.ts</span></span><br><span class="line"><span class="keyword">import</span> commonConfig <span class="keyword">from</span> <span class="string">'./webpack.common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> devConfig = merge(commonConfig, &#123;</span><br><span class="line">  devtool: <span class="string">'eval-source-map'</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>这里顺便提一下 webpack 插件 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Ntb290aC1jb2RlL2Vycm9yLW92ZXJsYXktd2VicGFjay1wbHVnaW4=" title="https://github.com/smooth-code/error-overlay-webpack-plugin">error-overlay-webpack-plugin<i class="fa fa-external-link"></i></span>，它提供了和 create-react-app 一样的错误遮罩：</p><p><img data-src="https://raw.githubusercontent.com/smooth-code/error-overlay-webpack-plugin/master/docs/example.png" alt="error overlay"></p><p>但是它有一个限制就是不能使用任何一种基于 <code>eval</code> 的 sourcemap，感兴趣的读者可以尝试以下。</p><h3 id="热更新"><a href="#热更新" class="headerlink" title="热更新"></a>热更新</h3><p>我们前面给 devServer 添加了 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dlYnBhY2stY29udHJpYi93ZWJwYWNrLWhvdC1taWRkbGV3YXJl" title="https://github.com/webpack-contrib/webpack-hot-middleware">webpack-hot-middleware<i class="fa fa-external-link"></i></span> 中间件，参考它的文档我们需要先添加 webapck 插件<code>webpack.HotModuleReplacementPlugin</code>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.dev.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; HotModuleReplacementPlugin, NamedModulesPlugin &#125; <span class="keyword">from</span> <span class="string">'webpack'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> devConfig = merge(commonConfig, &#123;</span><br><span class="line">  plugins: [<span class="keyword">new</span> HotModuleReplacementPlugin()],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>还要添加 <code>&#39;webpack-hot-middleware/client&#39;</code> 热更新补丁到我们的 bundle，加入 entry 数组即可：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.common.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; __DEV__, hmrPath &#125; <span class="keyword">from</span> <span class="string">'../env'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> commonConfig: Configuration = &#123;</span><br><span class="line">    entry: [resolvePath(projectRoot, <span class="string">'./src/index.tsx'</span>)],</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    (commonConfig.entry <span class="keyword">as</span> string[]).unshift(<span class="string">`webpack-hot-middleware/client?path=<span class="subst">$&#123;hmrPath&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过在 entry 后面加 <code>queryString</code> 的方式可以让我们配置一些选项，它是怎么实现的呢？查看 <code>&#39;webpack-hot-middleware/client&#39;</code> 源码可以看到，webpack 会将 <code>queryString</code> 作为全局变量注入这个文件：</p><p><img data-src="https://i.loli.net/2020/02/18/h1njS2olHADUV8R.png" alt="entry query"></p><p>其实到这我们也就支持了 CSS 的热更新（style-loader 实现了热更新接口），如果要支持 react 组件的热更新我们还需要配置 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dhZWFyb24vcmVhY3QtaG90LWxvYWRlcg==" title="https://github.com/gaearon/react-hot-loader">react-hot-loader<i class="fa fa-external-link"></i></span> ，配置它之前我们先来优化我们的 babel 配置。</p><h3 id="babel-配置优化"><a href="#babel-配置优化" class="headerlink" title="babel 配置优化"></a>babel 配置优化</h3><p>前面我们在前面只配置了一个 <code>@babel/preset-typescript</code> 插件用于编译 TypeScript，其实还有很多可以优化的点。</p><h4 id="babel-preset-env"><a href="#babel-preset-env" class="headerlink" title="@babel/preset-env"></a>@babel/preset-env</h4><p>在 babel 中，<strong>preset 表示 plugin 的集合</strong>，<code>@babel/preset-env</code> 可以让 babel 根据我们配置的 browserslist 只添加需要转换的语法和 polyfill。</p><p>安装 <code>@babel/preset-env</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add @babel/preset-env -D</span><br></pre></td></tr></table></figure><h4 id="babel-plugin-transform-runtime"><a href="#babel-plugin-transform-runtime" class="headerlink" title="@babel/plugin-transform-runtime"></a>@babel/plugin-transform-runtime</h4><p>我们知道默认情况下， babel 在编译每一个模块的时候在需要的时候会插入一些辅助函数例如 <code>_extend</code>，每一个需要的模块都会生成这个辅助函数会造成没必要的代码膨胀，<code>@babel/plugin-transform-runtime</code> 这个插件会将所有的辅助函数都从 <code>@babel/runtime</code> 导入，来减少代码体积。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add @babel/plugin-transform-runtime -D</span><br></pre></td></tr></table></figure><h4 id="babel-preset-react"><a href="#babel-preset-react" class="headerlink" title="@babel/preset-react"></a>@babel/preset-react</h4><p>虽然 <code>@babel/preset-typescript</code> 就能转换 tsx 成 js 代码，但是 <code>@babel/preset-react</code> 还集成了一些针对 react 项目的实用的插件。</p><p><code>@babel/preset-react</code> 默认会开启下面这些插件:</p><ul><li><span class="exturl" data-url="aHR0cHM6Ly9iYWJlbGpzLmlvL2RvY3MvZW4vYmFiZWwtcGx1Z2luLXN5bnRheC1qc3g=" title="https://babeljs.io/docs/en/babel-plugin-syntax-jsx">@babel/plugin-syntax-jsx<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9iYWJlbGpzLmlvL2RvY3MvZW4vYmFiZWwtcGx1Z2luLXRyYW5zZm9ybS1yZWFjdC1qc3g=" title="https://babeljs.io/docs/en/babel-plugin-transform-react-jsx">@babel/plugin-transform-react-jsx<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9iYWJlbGpzLmlvL2RvY3MvZW4vYmFiZWwtcGx1Z2luLXRyYW5zZm9ybS1yZWFjdC1kaXNwbGF5LW5hbWU=" title="https://babeljs.io/docs/en/babel-plugin-transform-react-display-name">@babel/plugin-transform-react-display-name<i class="fa fa-external-link"></i></span></li></ul><p>如果设置了 <code>development: true</code> 还会开启:</p><ul><li><span class="exturl" data-url="aHR0cHM6Ly9iYWJlbGpzLmlvL2RvY3MvZW4vYmFiZWwtcGx1Z2luLXRyYW5zZm9ybS1yZWFjdC1qc3gtc2VsZg==" title="https://babeljs.io/docs/en/babel-plugin-transform-react-jsx-self">@babel/plugin-transform-react-jsx-self<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9iYWJlbGpzLmlvL2RvY3MvZW4vYmFiZWwtcGx1Z2luLXRyYW5zZm9ybS1yZWFjdC1qc3gtc291cmNl" title="https://babeljs.io/docs/en/babel-plugin-transform-react-jsx-source">@babel/plugin-transform-react-jsx-source<i class="fa fa-external-link"></i></span></li></ul><p>安装依赖 <code>@babel/preset-react</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add @babel/preset-react -D</span><br></pre></td></tr></table></figure><h4 id="react-hot-loader"><a href="#react-hot-loader" class="headerlink" title="react-hot-loader"></a>react-hot-loader</h4><p>为了实现组件的局部刷新，我们需要安装 <code>react-hot-loader</code> 这个 babel 插件。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add react-hot-loader</span><br></pre></td></tr></table></figure><p>这个插件不需要安装成 <code>devDependencies</code>，它在生产环境下不会被执行并且会确保它占用的体积最小。其实官方正在开发下一代的 react 热更新插件 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL3JlYWN0L2lzc3Vlcy8xNjYwNA==" title="https://github.com/facebook/react/issues/16604">React Fast Refresh<i class="fa fa-external-link"></i></span>，不过目前还不支持 webpack。</p><p>为了看到测试效果，我们安装 react 全家桶并且调整一下 <code>src</code> 文件夹下的默认内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yarn add react react-dom react-router-dom</span><br><span class="line">yarn add @types/react @types/react-dom @types/react-router-dom -D</span><br></pre></td></tr></table></figure><p><code>react</code> 是框架核心接口，<code>react-dom</code> 负责挂载我们的 react 组件到真实的 DOM 上， <code>react-dom-router</code> 是实现了 <code>react-router</code> 接口的 web 平台的路由库。</p><p>让 <code>react-hot-loader</code> 接管我们的 react 根组件，其实这个 hot 函数就是一个 <strong>hoc</strong> 嘛：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// App.ts</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; hot &#125; <span class="keyword">from</span> <span class="string">'react-hot-loader/root'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./App.scss'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"app"</span>&gt;</span><br><span class="line">      &lt;h2 className=<span class="string">"title"</span>&gt;react typescript boilerplate&lt;<span class="regexp">/h2&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> hot(App);</span><br></pre></td></tr></table></figure><p>在 webpack entry 加入热更新补丁：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> commonConfig: Configuration = &#123;</span><br><span class="line">  entry: [<span class="string">'react-hot-loader/patch'</span>, resolvePath(projectRoot, <span class="string">'./src/index.tsx'</span>)],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>官方文档提到如果需要支持 <code>react hooks</code> 的热更新，我们还需要安装 <code>@hot-loader/react-dom</code>，使用它来替换默认的 <code>react-dom</code> 来添加一些额外的热更新特性，为了替换 <code>react-dom</code> 我们需要配置 webpack alias：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.common.ts</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  resolve: &#123;</span><br><span class="line">    alias: &#123;</span><br><span class="line">      <span class="string">'react-dom'</span>: <span class="string">'@hot-loader/react-dom'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>结合前面提到 babel 插件，最终修改 <code>babel.config.js</code> 成：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> envPreset = [</span><br><span class="line">  <span class="string">'@babel/preset-env'</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 只导入需要的 polyfill</span></span><br><span class="line">    useBuiltIns: <span class="string">'usage'</span>,</span><br><span class="line">    <span class="comment">// 指定 corjs 版本</span></span><br><span class="line">    corejs: <span class="number">3</span>,</span><br><span class="line">    <span class="comment">// 禁用模块化方案转换</span></span><br><span class="line">    modules: <span class="literal">false</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">api</span>) </span>&#123;</span><br><span class="line">  api.cache(<span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    presets: [<span class="string">'@babel/preset-typescript'</span>, envPreset],</span><br><span class="line">    plugins: [<span class="string">'@babel/plugin-transform-runtime'</span>],</span><br><span class="line">    env: &#123;</span><br><span class="line">      <span class="comment">// 开发环境配置</span></span><br><span class="line">      development: &#123;</span><br><span class="line">        presets: [[<span class="string">'@babel/preset-react'</span>, &#123; <span class="attr">development</span>: <span class="literal">true</span> &#125;]],</span><br><span class="line">        plugins: [<span class="string">'react-hot-loader/babel'</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 生产环境配置</span></span><br><span class="line">      production: &#123;</span><br><span class="line">        presets: [<span class="string">'@babel/preset-react'</span>],</span><br><span class="line">        plugins: [<span class="string">'@babel/plugin-transform-react-constant-elements'</span>, <span class="string">'@babel/plugin-transform-react-inline-elements'</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>注意到我们生产环境下还安装了两个插件进行生产环境的优化：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add @babel/plugin-transform-react-constant-elements @babel/plugin-transform-react-inline-elements -D</span><br></pre></td></tr></table></figure><p><code>@babel/plugin-transform-react-constant-elements</code> 的作用是像下面样将函数组件中的变量提升到函数外来避免每次重新调用函数组件重复声明和没必要的垃圾回收：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Hr = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">hr</span> <span class="attr">className</span>=<span class="string">"hr"</span> /&gt;</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转换成</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> _ref = <span class="xml"><span class="tag">&lt;<span class="name">hr</span> <span class="attr">className</span>=<span class="string">"hr"</span> /&gt;</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Hr = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> _ref;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>@babel/plugin-transform-react-inline-elements</code> 的作用读者可以参考 react 的这个 issue：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL3JlYWN0L2lzc3Vlcy8zMjI4" title="https://github.com/facebook/react/issues/3228">Optimizing Compiler: Inline ReactElements<i class="fa fa-external-link"></i></span>。</p><h2 id="生产环境优化"><a href="#生产环境优化" class="headerlink" title="生产环境优化"></a>生产环境优化</h2><h3 id="添加版权声明"><a href="#添加版权声明" class="headerlink" title="添加版权声明"></a>添加版权声明</h3><p>这个直接用 webpack 内置的 <code>BannerPlugin</code> 即可:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; BannerPlugin &#125; <span class="keyword">from</span> <span class="string">'webpack'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mergedConfig = merge(commonConfig, &#123;</span><br><span class="line">  mode: <span class="string">'production'</span>,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> BannerPlugin(&#123;</span><br><span class="line">      raw: <span class="literal">true</span>,</span><br><span class="line">      banner: <span class="string">`/** @preserve Powered by react-typescript-boilerplate (https://github.com/tjx666/react-typescript-boilerplate) */`</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><img data-src="https://i.loli.net/2020/02/20/DusmAYnTV2JL4Xv.png" alt="copyright"></p><p>需要注意的是我们在版权声明的注释中加了 <code>@preserve</code> 标记，我们后面会使用 <code>terser</code> 在生产环境构建时压缩代码，压缩代码时会去掉所有注释，除了一些包含特殊标记的注释，例如我们添加的 <code>@preserve</code>。</p><h3 id="CSS-拆分"><a href="#CSS-拆分" class="headerlink" title="CSS 拆分"></a>CSS 拆分</h3><p>如果 CSS 是包含在我们打包的 JS bundle 中那会导致最后体积很大，严重情况下访问首页会造成短暂的白屏。拆分 CSS 我们直接使用 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dlYnBhY2stY29udHJpYi9taW5pLWNzcy1leHRyYWN0LXBsdWdpbg==" title="https://github.com/webpack-contrib/mini-css-extract-plugin">mini-css-extract-plugin<i class="fa fa-external-link"></i></span>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add mini-css-extract-plugin -D</span><br></pre></td></tr></table></figure><p>修改生产环境配置：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.prod.ts</span></span><br><span class="line"><span class="keyword">import</span> MiniCssExtractPlugin <span class="keyword">from</span> <span class="string">'mini-css-extract-plugin'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> prodConfig = merge(commonConfig, &#123;</span><br><span class="line">  mode: <span class="string">'production'</span>,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> MiniCssExtractPlugin(&#123;</span><br><span class="line">      <span class="comment">// 文件名中插入文件内容的 hash 值</span></span><br><span class="line">      filename: <span class="string">'css/[name].[contenthash].css'</span>,</span><br><span class="line">      chunkFilename: <span class="string">'css/[id].[contenthash].css'</span>,</span><br><span class="line">      ignoreOrder: <span class="literal">false</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dlYnBhY2stY29udHJpYi9taW5pLWNzcy1leHRyYWN0LXBsdWdpbg==" title="https://github.com/webpack-contrib/mini-css-extract-plugin">mini-css-extract-plugin<i class="fa fa-external-link"></i></span> 还提供了 <code>mini-css-extract-plugin.loader</code>，它不能和 <code>style-loader</code> 共存，所以我们修改 <code>webpack.common.ts</code> 的配置使得开发环境下使用 <code>style-loader</code> 生产环境下使用 <code>mini-css-extract-plugin.loader</code>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; loader <span class="keyword">as</span> MiniCssExtractLoader &#125; <span class="keyword">from</span> <span class="string">'mini-css-extract-plugin'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; __DEV__ &#125; <span class="keyword">from</span> <span class="string">'../env'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCssLoaders</span>(<span class="params">importLoaders: number</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    __DEV__ ? <span class="string">'style-loader'</span> : MiniCssExtractLoader,</span><br><span class="line">    &#123;</span><br><span class="line">      loader: <span class="string">'css-loader'</span>,</span><br><span class="line">      options: &#123;</span><br><span class="line">        modules: <span class="literal">false</span>,</span><br><span class="line">        sourceMap: <span class="literal">true</span>,</span><br><span class="line">        importLoaders,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      loader: <span class="string">'postcss-loader'</span>,</span><br><span class="line">      options: &#123; <span class="attr">sourceMap</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="代码压缩"><a href="#代码压缩" class="headerlink" title="代码压缩"></a>代码压缩</h3><h4 id="JavaScript-压缩"><a href="#JavaScript-压缩" class="headerlink" title="JavaScript 压缩"></a>JavaScript 压缩</h4><p>网上很多教程在讲 webpack 压缩代码的时候都是使用 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dlYnBhY2stY29udHJpYi91Z2xpZnlqcy13ZWJwYWNrLXBsdWdpbg==" title="https://github.com/webpack-contrib/uglifyjs-webpack-plugin">uglifyjs-webpack-plugin<i class="fa fa-external-link"></i></span>，其实这个仓库早就放弃维护了，而且它不支持 ES6 语法，webpack 的核心开发者 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2V2aWxlYm90dG5hd2k=" title="https://github.com/evilebottnawi">evilebottnawi<i class="fa fa-external-link"></i></span> 都转向维护 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dlYnBhY2stY29udHJpYi90ZXJzZXItd2VicGFjay1wbHVnaW4=" title="https://github.com/webpack-contrib/terser-webpack-plugin">terser-webpack-plugin<i class="fa fa-external-link"></i></span> 了。我们使用 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dlYnBhY2stY29udHJpYi90ZXJzZXItd2VicGFjay1wbHVnaW4=" title="https://github.com/webpack-contrib/terser-webpack-plugin">terser-webpack-plugin<i class="fa fa-external-link"></i></span> 在生产环境对代码进行压缩，并且我们可以利用 webpack4 新增的 <span class="exturl" data-url="aHR0cHM6Ly93d3cud2VicGFja2pzLmNvbS9ndWlkZXMvdHJlZS1zaGFraW5nLw==" title="https://www.webpackjs.com/guides/tree-shaking/">tree-shaking<i class="fa fa-external-link"></i></span> 去除代码中的死代码，进一步减小 bundle 体积：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add terser-webpack-plugin @types/terser-webpack-plugin -D</span><br></pre></td></tr></table></figure><p>treeshake 需要在 <code>package.json</code> 中配置 <code>sideEffects</code> 字段，详情可以阅读官方文档：<span class="exturl" data-url="aHR0cHM6Ly93ZWJwYWNrLmpzLm9yZy9ndWlkZXMvdHJlZS1zaGFraW5nLw==" title="https://webpack.js.org/guides/tree-shaking/">Tree Shaking<i class="fa fa-external-link"></i></span>。</p><h4 id="CSS-压缩"><a href="#CSS-压缩" class="headerlink" title="CSS 压缩"></a>CSS 压缩</h4><p>压缩 CSS 使用 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL05NRlIvb3B0aW1pemUtY3NzLWFzc2V0cy13ZWJwYWNrLXBsdWdpbg==" title="https://github.com/NMFR/optimize-css-assets-webpack-plugin">optimize-css-assets-webpack-plugin<i class="fa fa-external-link"></i></span>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add optimize-css-assets-webpack-plugin @types/optimize-css-assets-webpack-plugin -D</span><br></pre></td></tr></table></figure><p>修改 <code>webpack.prod.ts</code>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> TerserPlugin <span class="keyword">from</span> <span class="string">'terser-webpack-plugin'</span>;</span><br><span class="line"><span class="keyword">import</span> OptimizeCSSAssetsPlugin <span class="keyword">from</span> <span class="string">'optimize-css-assets-webpack-plugin'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> prodConfig = merge(commonConfig, &#123;</span><br><span class="line">  mode: <span class="string">'production'</span>,</span><br><span class="line">  optimization: &#123;</span><br><span class="line">    <span class="comment">// 使用 minimizer 而不是默认的 uglifyJS</span></span><br><span class="line">    minimize: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// 两个 minimizer：TerserPlugin 和 OptimizeCSSAssetsPlugin</span></span><br><span class="line">    minimizer: [<span class="keyword">new</span> TerserPlugin(&#123; <span class="attr">extractComments</span>: <span class="literal">false</span> &#125;), <span class="keyword">new</span> OptimizeCSSAssetsPlugin()],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="构建分析"><a href="#构建分析" class="headerlink" title="构建分析"></a>构建分析</h3><p>我们添加一些 webpack 插件用来进行构建分析</p><h4 id="时间统计"><a href="#时间统计" class="headerlink" title="时间统计"></a>时间统计</h4><p><img data-src="https://i.loli.net/2020/02/19/c1vdoqsT34WCSHX.png" alt="speed measure"></p><p>我们使用 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3N0ZXBoZW5jb29rZGV2L3NwZWVkLW1lYXN1cmUtd2VicGFjay1wbHVnaW4=" title="https://github.com/stephencookdev/speed-measure-webpack-plugin">speed-measure-webpack-plugin<i class="fa fa-external-link"></i></span> 对打包时间进行统计：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add speed-measure-webpack-plugin -D</span><br></pre></td></tr></table></figure><p>项目进行到这，我们终于碰到第一个没有 TypeScript 类型声明文件的库了，新建 <code>scripts/typings/index.d.ts</code> 文件，因为需要编写的类型很少，<code>index.d.ts</code> 就作为一个全局声明文件，在其中添加 <code>speed-measure-webpack-plugin</code> 的外部模块声明：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// scripts/typings/index.d.ts</span></span><br><span class="line">declare <span class="built_in">module</span> <span class="string">'speed-measure-webpack-plugin'</span> &#123;</span><br><span class="line">    <span class="keyword">import</span> &#123; Configuration, Plugin &#125; <span class="keyword">from</span> <span class="string">'webpack'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查看官方文档，需要哪些选项就声明哪些选项就行</span></span><br><span class="line">  	<span class="comment">// 可以看出 TypeScript 是非常灵活的</span></span><br><span class="line">    interface SpeedMeasurePluginOptions &#123;</span><br><span class="line">        disable: boolean;</span><br><span class="line">        outputFormat: <span class="string">'json'</span> | <span class="string">'human'</span> | <span class="string">'humanVerbose'</span> | <span class="function">(<span class="params">(outputObj: object</span>) =&gt;</span> <span class="keyword">void</span>);</span><br><span class="line">        outputTarget: string | <span class="function">(<span class="params">(outputObj: string</span>) =&gt;</span> <span class="keyword">void</span>);</span><br><span class="line">        pluginNames: object;</span><br><span class="line">        granularLoaderData: boolean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 继承 Plugin 类, Plugin 类都有 apply 方法</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">SpeedMeasurePlugin</span> <span class="keyword">extends</span> <span class="title">Plugin</span> </span>&#123;</span><br><span class="line">        <span class="keyword">constructor</span>(options?: Partial&lt;SpeedMeasurePluginOptions&gt;);</span><br><span class="line">        wrap(webpackConfig: Configuration): Configuration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    export = SpeedMeasurePlugin;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改 <code>webpack.prod.ts</code>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> SpeedMeasurePlugin <span class="keyword">from</span> <span class="string">'speed-measure-webpack-plugin'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mergedConfig = merge(commonConfig, &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> smp = <span class="keyword">new</span> SpeedMeasurePlugin();</span><br><span class="line"><span class="keyword">const</span> prodConfig = smp.wrap(mergedConfig);</span><br></pre></td></tr></table></figure><h4 id="bundle-分析"><a href="#bundle-分析" class="headerlink" title="bundle 分析"></a>bundle 分析</h4><p><img data-src="https://i.loli.net/2020/02/19/Plifd7e9b2WOxsF.png" alt="bundle analyze"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add BundleAnalyzerPlugin @types/BundleAnalyzerPlugin -D</span><br></pre></td></tr></table></figure><p>我们添加一个 npm script 用于带 bundle 分析的构建，因为有些时候我们并不想打开一个浏览器去分析各个模块的大小和占比：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"scripts"</span>: &#123;</span><br><span class="line">    <span class="string">"build"</span>: <span class="string">"cross-env-shell NODE_ENV=production ts-node --files -P scripts/tsconfig.json scripts/build"</span>,</span><br><span class="line">    <span class="string">"build-analyze"</span>: <span class="string">"cross-env-shell NODE_ENV=production ts-node --files -P scripts/tsconfig.json scripts/build --analyze"</span>,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>修改 <code>webpack.prod.ts</code>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加</span></span><br><span class="line"><span class="keyword">import</span> &#123; isAnalyze &#125; <span class="keyword">from</span> <span class="string">'../env'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isAnalyze) &#123;</span><br><span class="line">    mergedConfig.plugins!.push(<span class="keyword">new</span> BundleAnalyzerPlugin());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样当我们想看各个模块在 bundle 中的大小和占比的时候可以运行 <code>npm run build-analyze</code>，将会自动在浏览器中打开上图中的页面。</p><h4 id="准备-gzip-压缩版本"><a href="#准备-gzip-压缩版本" class="headerlink" title="准备 gzip 压缩版本"></a>准备 gzip 压缩版本</h4><p>我们使用官方维护的 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dlYnBhY2stY29udHJpYi9jb21wcmVzc2lvbi13ZWJwYWNrLXBsdWdpbg==" title="https://github.com/webpack-contrib/compression-webpack-plugin">compression-webpack-plugin<i class="fa fa-external-link"></i></span> 来为打包出来的各个文件准备 gzip 压缩版：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add compression-webpack-plugin @types/compression-webpack-plugin -D</span><br></pre></td></tr></table></figure><h4 id="跟踪-gzip-后的资源大小"><a href="#跟踪-gzip-后的资源大小" class="headerlink" title="跟踪 gzip 后的资源大小"></a>跟踪 gzip 后的资源大小</h4><p><img data-src="https://i.loli.net/2020/02/19/Oteqp9js3DPFrCS.png" alt="trace size"></p><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0dvb2dsZUNocm9tZUxhYnMvc2l6ZS1wbHVnaW4=" title="https://github.com/GoogleChromeLabs/size-plugin">size-plugin<i class="fa fa-external-link"></i></span> 是谷歌出品的一个显示 webpack 各个 chunk gzip 压缩后的体积大小以及相比于上一次的大小变化，上图中红框中的部分显示了我加了一句 log 之后 gizip 体积增加了 11B。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add size-plugin -D</span><br></pre></td></tr></table></figure><p>这个库有没有官方的 types 文件，我们添加 <code>size-plugin</code> 的外部模块声明：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// scripts/typings/index.d.ts</span></span><br><span class="line">declare <span class="built_in">module</span> <span class="string">'size-plugin'</span> &#123;</span><br><span class="line">    <span class="keyword">import</span> &#123; Plugin &#125; <span class="keyword">from</span> <span class="string">'webpack'</span>;</span><br><span class="line"></span><br><span class="line">    interface SizePluginOptions &#123;</span><br><span class="line">        pattern: string;</span><br><span class="line">        exclude: string;</span><br><span class="line">        filename: string;</span><br><span class="line">        publish: boolean;</span><br><span class="line">        writeFile: boolean;</span><br><span class="line">        stripHash: <span class="built_in">Function</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">SizePlugin</span> <span class="keyword">extends</span> <span class="title">Plugin</span> </span>&#123;</span><br><span class="line">        <span class="keyword">constructor</span>(options?: Partial&lt;SizePluginOptions&gt;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    export = SizePlugin;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.prod.ts</span></span><br><span class="line"><span class="keyword">const</span> mergedConfig = merge(commonConfig, &#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="comment">// 不输出文件大小到磁盘</span></span><br><span class="line">    <span class="keyword">new</span> SizePlugin(&#123; <span class="attr">writeFile</span>: <span class="literal">false</span> &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>最近刚学会一个词 <code>TL; DR</code>，其实就是：</p><blockquote><p>Too long; didn’t read.</p></blockquote><p>其实我自己也是经常这样，哈哈。到这里已经有 1 万多字了，我估计应该没几个人会看到这。整个流程走下来我觉得是还是非常自然的，从开发环境到生产环境，从基本的配置到优化控制台显示，准备 gzip 压缩版本这些锦上添花的步骤。写这篇文章其实大部分的时间都花费在了查阅资料上，每一个插件我都尽量描述好它们的作用，如果有值得注意的地方我也会在代码注释中或者文字描述中提出来。我知道可能这篇文章对于一些基础比较差或者没怎么手动配置过 webpack 的同学压力比较大，很可能看不下去，这是正常的，我以前也是这样，不过我觉得你如果能够咬咬牙坚持读完，尽管很多地方看不懂，你总是会从中学到一些对你有用的东西，或者你也可以收藏下来当自字典来查。这篇文章很多配置并不是和 react+typescript 强耦合的，你加一个 vue-loader 不就可以正常使用 vue 来开发了吗？<strong>更重要的是我希望一些读者可以从中学到探索精神，可怕不代表不可能，实践探索才能掌握真知。</strong></p><p>最后我们加上我们的构建脚本 <code>build.ts</code>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// scripts/build.ts</span></span><br><span class="line"><span class="keyword">import</span> webpack <span class="keyword">from</span> <span class="string">'webpack'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> prodConfig <span class="keyword">from</span> <span class="string">'./configs/webpack.prod'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; isAnalyze &#125; <span class="keyword">from</span> <span class="string">'./env'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> compiler = webpack(prodConfig);</span><br><span class="line"></span><br><span class="line">compiler.run(<span class="function">(<span class="params">error, stats</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (error) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(error);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> prodStatsOpts = &#123;</span><br><span class="line">    preset: <span class="string">'normal'</span>,</span><br><span class="line">    modules: isAnalyze,</span><br><span class="line">    colors: <span class="literal">true</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(stats.toString(prodStatsOpts));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><img data-src="https://i.loli.net/2020/02/19/ecaJjBtpHIEQoxC.gif" alt="effect"></p><p>我最近一直在忙毕业和找工作的事情，下一篇可能要在一个月后左右了。如果读者对文章中有哪些不理解的地方建议先去看下<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RqeDY2Ni9yZWFjdC10eXBlc2NyaXB0LWJvaWxlcnBsYXRl" title="https://github.com/tjx666/react-typescript-boilerplate">源代码<i class="fa fa-external-link"></i></span>，还有问题的话可以在 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RqeDY2Ni9yZWFjdC10eXBlc2NyaXB0LWJvaWxlcnBsYXRlL2lzc3Vlcw==" title="https://github.com/tjx666/react-typescript-boilerplate/issues">github issues<i class="fa fa-external-link"></i></span> 或者发布平台的评论区向我提问，如果觉得本文对你有用，不妨赏颗 star 😁。</p><p>下一篇应该会讲述如何集成 <code>ant design</code>，<code>lodash</code> 等流行库并对它们的打包进行优化…</p><p>本文为原创内容，首发于<span class="exturl" data-url="aHR0cDovL3d3dy5seXJlYWw2NjYuY29tLw==" title="http://www.lyreal666.com/">个人博客<i class="fa fa-external-link"></i></span>，转载请注明出处。</p></div><p style="text-align:center">（完）</p><footer class="post-footer"><div class="post-tags"><a href="/tags/react/" rel="tag"><i class="fa fa-tag"></i> react</a> <a href="/tags/typescript/" rel="tag"><i class="fa fa-tag"></i> typescript</a> <a href="/tags/webpack/" rel="tag"><i class="fa fa-tag"></i> webpack</a> <a href="/tags/express/" rel="tag"><i class="fa fa-tag"></i> express</a> <a href="/tags/babel/" rel="tag"><i class="fa fa-tag"></i> babel</a></div><div class="post-nav"><div class="post-nav-item"><a href="/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E9%85%8D%E7%BD%AE-react-typescript%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9Alinters-%E5%92%8C-formatter/" rel="prev" title="从零开始配置 react + typescript（二）：linters 和 formatter"><i class="fa fa-chevron-left"></i> 从零开始配置 react + typescript（二）：linters 和 formatter</a></div><div class="post-nav-item"><a href="/%E9%82%A3%E4%BA%9B%E4%BD%A0%E5%BA%94%E8%AF%A5%E8%80%83%E8%99%91%E5%8D%B8%E8%BD%BD%E7%9A%84-VSCode-%E6%89%A9%E5%B1%95/" rel="next" title="那些你应该考虑卸载的 VSCode 扩展">那些你应该考虑卸载的 VSCode 扩展 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><script>window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#dev-server"><span class="nav-number">1.</span> <span class="nav-text">dev server</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#技术选型"><span class="nav-number">1.1.</span> <span class="nav-text">技术选型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实现最基本的打包功能"><span class="nav-number">1.2.</span> <span class="nav-text">实现最基本的打包功能</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置入口文件"><span class="nav-number">1.2.1.</span> <span class="nav-text">配置入口文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编译-TypeScript"><span class="nav-number">1.2.2.</span> <span class="nav-text">编译 TypeScript</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#添加-webpack-配置"><span class="nav-number">1.2.3.</span> <span class="nav-text">添加 webpack 配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用-express-开发-devServer"><span class="nav-number">1.2.4.</span> <span class="nav-text">使用 express 开发 devServer</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开发环境优化"><span class="nav-number">2.</span> <span class="nav-text">开发环境优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#plugins"><span class="nav-number">2.1.</span> <span class="nav-text">plugins</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#显示打包进度"><span class="nav-number">2.1.1.</span> <span class="nav-text">显示打包进度</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#优化控制台输出"><span class="nav-number">2.1.2.</span> <span class="nav-text">优化控制台输出</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#构建通知"><span class="nav-number">2.1.3.</span> <span class="nav-text">构建通知</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#严格检查路径大小写"><span class="nav-number">2.1.4.</span> <span class="nav-text">严格检查路径大小写</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#循环依赖检查"><span class="nav-number">2.1.5.</span> <span class="nav-text">循环依赖检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#清理上次打包的-bundle"><span class="nav-number">2.1.6.</span> <span class="nav-text">清理上次打包的 bundle</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#自动生成-index-html"><span class="nav-number">2.1.7.</span> <span class="nav-text">自动生成 index.html</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#拷贝文件到-dist"><span class="nav-number">2.1.8.</span> <span class="nav-text">拷贝文件到 dist</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#检查-TypeScript-类型"><span class="nav-number">2.1.9.</span> <span class="nav-text">检查 TypeScript 类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#缓存神器"><span class="nav-number">2.1.10.</span> <span class="nav-text">缓存神器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#loaders"><span class="nav-number">2.2.</span> <span class="nav-text">loaders</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#处理样式文件"><span class="nav-number">2.2.1.</span> <span class="nav-text">处理样式文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#CSS"><span class="nav-number">2.2.1.1.</span> <span class="nav-text">CSS</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#less"><span class="nav-number">2.2.1.2.</span> <span class="nav-text">less</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sass"><span class="nav-number">2.2.1.3.</span> <span class="nav-text">sass</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#postcss"><span class="nav-number">2.2.1.4.</span> <span class="nav-text">postcss</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#处理图片和字体"><span class="nav-number">2.2.2.</span> <span class="nav-text">处理图片和字体</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sourcemap"><span class="nav-number">2.3.</span> <span class="nav-text">sourcemap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#热更新"><span class="nav-number">2.4.</span> <span class="nav-text">热更新</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#babel-配置优化"><span class="nav-number">2.5.</span> <span class="nav-text">babel 配置优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#babel-preset-env"><span class="nav-number">2.5.1.</span> <span class="nav-text">@babel&#x2F;preset-env</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#babel-plugin-transform-runtime"><span class="nav-number">2.5.2.</span> <span class="nav-text">@babel&#x2F;plugin-transform-runtime</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#babel-preset-react"><span class="nav-number">2.5.3.</span> <span class="nav-text">@babel&#x2F;preset-react</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#react-hot-loader"><span class="nav-number">2.5.4.</span> <span class="nav-text">react-hot-loader</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#生产环境优化"><span class="nav-number">3.</span> <span class="nav-text">生产环境优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#添加版权声明"><span class="nav-number">3.1.</span> <span class="nav-text">添加版权声明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSS-拆分"><span class="nav-number">3.2.</span> <span class="nav-text">CSS 拆分</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码压缩"><span class="nav-number">3.3.</span> <span class="nav-text">代码压缩</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#JavaScript-压缩"><span class="nav-number">3.3.1.</span> <span class="nav-text">JavaScript 压缩</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CSS-压缩"><span class="nav-number">3.3.2.</span> <span class="nav-text">CSS 压缩</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#构建分析"><span class="nav-number">3.4.</span> <span class="nav-text">构建分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#时间统计"><span class="nav-number">3.4.1.</span> <span class="nav-text">时间统计</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bundle-分析"><span class="nav-number">3.4.2.</span> <span class="nav-text">bundle 分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#准备-gzip-压缩版本"><span class="nav-number">3.4.3.</span> <span class="nav-text">准备 gzip 压缩版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#跟踪-gzip-后的资源大小"><span class="nav-number">3.4.4.</span> <span class="nav-text">跟踪 gzip 后的资源大小</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="余腾靖" src="/images/avatar.png"><p class="site-author-name" itemprop="name">余腾靖</p><div class="site-description" itemprop="description">总结和分享我的所学所思</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">5</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">23</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS95dS10ZW5nLWppbmcvYWN0aXZpdGllcw==" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;yu-teng-jing&#x2F;activities"><i class="fa fa-fw fa-bookmark"></i>知乎</span> </span><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uaW0vdXNlci81YWQwZGNhYTZmYjlhMDI4ZDkzNzk0Yjk=" title="掘金 → https:&#x2F;&#x2F;juejin.im&#x2F;user&#x2F;5ad0dcaa6fb9a028d93794b9"><i class="fa fa-fw fa-book"></i>掘金</span> </span><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RqeDY2Ng==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;tjx666"><i class="fa fa-fw fa-github"></i>GitHub</span> </span><span class="links-of-author-item"><span class="exturl" data-url="bWFpbHRvOnl0ajI3MTMxNTE3MTNAZ21haWwuY29t" title="E-Mail → mailto:ytj2713151713@gmail.com"><i class="fa fa-fw fa-envelope"></i>E-Mail</span> </span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-fw fa-rss"></i>RSS</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2020</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">余腾靖</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span> </span></span><span class="post-meta-divider">|</span> <span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/js/local-search.js"></script><script>if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme: 'forest',
      logLevel: 3,
      flowchart: { curve: 'linear' },
      gantt: { axisFormat: '%m/%d/%Y' },
      sequence: { actorMargin: 50 }
    });
  }, window.mermaid);
}</script></body></html>